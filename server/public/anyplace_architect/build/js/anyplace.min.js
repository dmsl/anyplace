function CanvasOverlay(a,b){for(this.top=0,this.left=0,this.width=a.width,this.height=a.height;window&&(this.width>window.innerWidth||this.height>window.innerHeight);)this.width/=2,this.height/=2;this.image_=a,this.map_=b,this.div_=null,this.canvas=null,this.ctx=null,this.angle=0,this.scale=1,this.latlng=b.getCenter(),this.new_left=0,this.new_top=0,this.setMap(b)}function deg2rad(a){return a*Math.PI/180}function rad2deg(a){return a/Math.PI*180}function getRotationDegrees(a){var b=a.css("-webkit-transform")||a.css("-moz-transform")||a.css("-ms-transform")||a.css("-o-transform")||a.css("transform");if("none"!==b)var c=b.split("(")[1].split(")")[0].split(","),d=c[0],e=c[1],f=(c[2],c[3],Math.sqrt(d*d+e*e),Math.round(Math.atan2(e,d)*(180/Math.PI)));else var f=0;return f}function hexToBase64(a){return btoa(String.fromCharCode.apply(null,a.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function base64_encode(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);m=n.join("");var o=a.length%3;return(o?m.slice(0,o-3):m)+"===".slice(o||3)}function USGSOverlay(a,b,c){this.bounds_=a,this.image_=b,this.image64=b,this.map_=c,this.div_=null,this.setMap(c)}var app=angular.module("anyArchitect",["ui.bootstrap","ui.select","ngSanitize"]);app.service("GMapService",function(){this.gmap={};var a=this,b={center:{lat:35.14448545801575,lng:33.41121554374695},zoom:8,panControl:!0,zoomControl:!0,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},scaleControl:!0,streetViewControl:!1,overviewMapControl:!0};a.gmap=new google.maps.Map(document.getElementById("map-canvas"),b);var c=document.getElementById("pac-input");a.gmap.controls[google.maps.ControlPosition.TOP_LEFT].push(c),a.searchBox=new google.maps.places.SearchBox(c),google.maps.event.addListener(a.searchBox,"places_changed",function(){var b=a.searchBox.getPlaces();0!=b.length&&(a.gmap.panTo(b[0].geometry.location),a.gmap.setZoom(17))}),a.gmap.addListener(a.gmap,"bounds_changed",function(){var b=a.gmap.getBounds();a.searchBox.setBounds(b)})}),app.factory("AnyplaceService",function(){var a={};return a.selectedBuilding=void 0,a.selectedFloor=void 0,a.selectedPoi=void 0,a.alerts=[],a.jsonReq={username:"username",password:"password"},a.getBuilding=function(){return this.selectedBuilding},a.getBuildingId=function(){return this.selectedBuilding?this.selectedBuilding.buid:void 0},a.getBuildingName=function(){return this.selectedBuilding?this.selectedBuilding.name:"N/A"},a.getFloor=function(){return this.selectedFloor},a.getFloorNumber=function(){return this.selectedFloor?String(this.selectedFloor.floor_number):"N/A"},a.getFloorName=function(){return this.selectedFloor.floor_name},a.setBuilding=function(a){this.selectedBuilding=a},a.setFloor=function(a){this.selectedFloor=a},a.addAlert=function(a,b){this.alerts[0]={msg:b,type:a}},a.closeAlert=function(a){this.alerts.splice(a,1)},a.getBuildingViewerUrl=function(){return this.selectedBuilding&&this.selectedBuilding.buid?"http://anyplace.cs.ucy.ac.cy/viewer/?buid="+this.selectedBuilding.buid:"N/A"},a.clearAllData=function(){a.selectedPoi=void 0,a.selectedFloor=void 0,a.selectedBuilding=void 0},a}),app.factory("Alerter",function(){var a={};return a.AlertCtrl="-",a}),app.factory("formDataObject",function(){return function(a,b){var c=new FormData;angular.forEach(a,function(a,b){c.append(b,a)});var d=b();return delete d["Content-Type"],c}}),app.config(["$locationProvider",function(a){a.html5Mode(!0)}]),app.filter("propsFilter",function(){return function(a,b){var c=[];return angular.isArray(a)?a.forEach(function(a){for(var d=!1,e=Object.keys(b),f=0;f<e.length;f++){var g=e[f],h=b[g].toLowerCase();if(-1!==a[g].toString().toLowerCase().indexOf(h)){d=!0;break}}d&&c.push(a)}):c=a,c}}),app.factory("myInterceptor",[function(){var a={request:function(a){return 0!=a.url.indexOf(AnyplaceAPI.FULL_SERVER)?a:(a.data&&(a.data.access_token=app.access_token),a)}};return a}]),app.config(["$httpProvider",function(a){a.interceptors.push("myInterceptor")}]);var AnyplaceAPI={};AnyplaceAPI.FULL_SERVER="http://anyplace.rayzit.com/anyplace",AnyplaceAPI.Mapping={},AnyplaceAPI.Mapping.RADIO_HEATMAP="/mapping/radio/heatmap_building_floor",AnyplaceAPI.Mapping.RADIO_HEATMAP_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.RADIO_HEATMAP,AnyplaceAPI.Mapping.BUILDING_ADD="/mapping/building/add",AnyplaceAPI.Mapping.BUILDING_ADD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_ADD,AnyplaceAPI.Mapping.BUILDING_UPDATE="/mapping/building/update",AnyplaceAPI.Mapping.BUILDING_UPDATE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_UPDATE,AnyplaceAPI.Mapping.BUILDING_DELETE="/mapping/building/delete",AnyplaceAPI.Mapping.BUILDING_DELETE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_DELETE,AnyplaceAPI.Mapping.BUILDING_ALL="/mapping/building/all_owner",AnyplaceAPI.Mapping.BUILDING_ALL_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_ALL,AnyplaceAPI.Mapping.FLOOR_ADD="/mapping/floor/add",AnyplaceAPI.Mapping.FLOOR_ADD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_ADD,AnyplaceAPI.Mapping.FLOOR_UPDATE="/mapping/floor/update",AnyplaceAPI.Mapping.FLOOR_UPDATE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_UPDATE,AnyplaceAPI.Mapping.FLOOR_DELETE="/mapping/floor/delete",AnyplaceAPI.Mapping.FLOOR_DELETE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_DELETE,AnyplaceAPI.Mapping.FLOOR_ALL="/mapping/floor/all",AnyplaceAPI.Mapping.FLOOR_ALL_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_ALL,AnyplaceAPI.Mapping.FLOOR_PLAN_UPLOAD="/mapping/floor/upload",AnyplaceAPI.Mapping.FLOOR_PLAN_UPLOAD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_PLAN_UPLOAD,AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD="/floorplans64/",AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD,AnyplaceAPI.Mapping.POIS_ADD="/mapping/pois/add",AnyplaceAPI.Mapping.POIS_ADD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_ADD,AnyplaceAPI.Mapping.POIS_UPDATE="/mapping/pois/update",AnyplaceAPI.Mapping.POIS_UPDATE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_UPDATE,AnyplaceAPI.Mapping.POIS_DELETE="/mapping/pois/delete",AnyplaceAPI.Mapping.POIS_DELETE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_DELETE,AnyplaceAPI.Mapping.POIS_ALL_FLOOR="/mapping/pois/all_floor",AnyplaceAPI.Mapping.POIS_ALL_FLOOR_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_ALL_FLOOR,AnyplaceAPI.Mapping.CONNECTION_ADD="/mapping/connection/add",AnyplaceAPI.Mapping.CONNECTION_ADD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.CONNECTION_ADD,AnyplaceAPI.Mapping.CONNECTION_UPDATE="/mapping/connection/update",AnyplaceAPI.Mapping.CONNECTION_UPDATE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.CONNECTION_UPDATE,AnyplaceAPI.Mapping.CONNECTION_DELETE="/mapping/connection/delete",AnyplaceAPI.Mapping.CONNECTION_DELETE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.CONNECTION_DELETE,AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR="/mapping/connection/all_floor",AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR,AnyplaceAPI.Mapping.SIGN="/mapping/accounts/sign",AnyplaceAPI.Mapping.SIGN_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.SIGN,app.factory("AnyplaceAPIService",["$http","$q","formDataObject",function(a,b,c){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"];var d={};return d.getRadioHeatmap=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.RADIO_HEATMAP_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.addBuilding=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_ADD_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.updateBuilding=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_UPDATE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.deleteBuilding=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_DELETE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.allBuildings=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_ALL_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.addFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_ADD_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.updateFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_UPDATE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.deleteFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_DELETE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.allBuildingFloors=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_ALL_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.uploadFloorPlan=function(b,d){return alert("make the request: "+b),a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_PLAN_UPLOAD_URL,headers:{"Content-Type":"multipart/form-data"},data:{floorplan:d,json:b},transformRequest:c}).success(function(a,b){return a}).error(function(a,b){return a})},d.uploadFloorPlan64=function(b,c){var d=c.replace("data:image/png;base64,",""),e=LPUtils.Base64Binary.decode(d),f=new Blob([e]);d="";for(var g=0;g<e.length;g++)d+=e[g];var h=new FormData;return h.append("json",b),h.append("floorplan",f),a.post(AnyplaceAPI.Mapping.FLOOR_PLAN_UPLOAD_URL,h,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(a,b){return a}).error(function(a,b){return a})},d.downloadFloorPlan=function(b,c,d){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD_URL+c+"/"+d,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.addPois=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_ADD_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.updatePois=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_UPDATE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.deletePois=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_DELETE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrievePoisByBuildingFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_ALL_FLOOR_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.addConnection=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.CONNECTION_ADD_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.updateConnection=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.CONNECTION_UPDATE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.deleteConnection=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.CONNECTION_DELETE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrieveConnectionsByBuildingFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.signAccount=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.SIGN_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d}]),CanvasOverlay.prototype=new google.maps.OverlayView,CanvasOverlay.prototype.onAdd=function(){function a(a){return parseInt(a,10)||0}function b(a){var b=window.getComputedStyle(a,null),c=b.getPropertyValue("-webkit-transform")||b.getPropertyValue("-moz-transform")||b.getPropertyValue("-ms-transform")||b.getPropertyValue("-o-transform")||b.getPropertyValue("transform")||null;if(c&&"none"!=c){var d=c.split("(")[1];d=d.split(")")[0],d=d.split(",");for(var e=d[0],f=d[1],g=Math.round(Math.atan2(f,e)*(180/Math.PI));g>=360;)g=360-g;for(;0>g;)g=360+g;return g}return 0}function c(a){return isNaN(parseFloat(a))?0:parseFloat(a)}function d(a){return Math.round(100*(a+1e-5))/100}var e=document.createElement("div");e.id="canvas_editor",e.style.border="none",e.style.borderWidth="0px",e.style.position="relative",e.style.top=this.top,e.style.left=this.left;var f;if(null!=(f=this.getProjection())){var g=f.fromLatLngToDivPixel(this.latlng);e.style.top=g.y-this.height/2+"px",e.style.left=g.x-this.width/2+"px"}var h=this;jQuery.getCorrection=function(a,b,c,d,e){var e=e*Math.PI/180,f=-a/2,g=b/2,h=g*Math.sin(e)+f*Math.cos(e),i=g*Math.cos(e)-f*Math.sin(e),j={left:h-f,top:i-g},k=a+c,l=b+d,f=-k/2,g=l/2,h=g*Math.sin(e)+f*Math.cos(e),i=g*Math.cos(e)-f*Math.sin(e),m={left:h-f,top:i-g},n={left:m.left-j.left,top:m.top-j.top};return n},jQuery.ui.resizable.prototype._mouseStart=function(b){var c,d,e,f=this.options,g=this.element;return this.resizing=!0,this._renderProxy(),c=a(this.helper.css("left")),d=a(this.helper.css("top")),f.containment&&(c+=$(f.containment).scrollLeft()||0,d+=$(f.containment).scrollTop()||0),this.offset=this.helper.offset(),this.position={left:c,top:d},this.size=this._helper?{width:this.helper.width(),height:this.helper.height()}:{width:g.width(),height:g.height()},this.originalSize=this._helper?{width:g.outerWidth(),height:g.outerHeight()}:{width:g.width(),height:g.height()},this.sizeDiff={width:g.outerWidth()-g.width(),height:g.outerHeight()-g.height()},this.originalPosition={left:c,top:d},this.originalMousePosition={left:b.pageX,top:b.pageY},this.lastData=this.originalPosition,this.aspectRatio="number"==typeof f.aspectRatio?f.aspectRatio:this.originalSize.width/this.originalSize.height||1,e=$(".ui-resizable-"+this.axis).css("cursor"),$("body").css("cursor","auto"===e?this.axis+"-resize":e),g.addClass("ui-resizable-resizing"),this._propagate("start",b),!0},jQuery.ui.resizable.prototype._mouseDrag=function(a){var e,f=b(this.element[0]),g=f*Math.PI/180,h=this.helper,i={},j=this.originalMousePosition,k=this.axis,l=this.position.top,m=this.position.left,n=this.size.width,o=this.size.height,p=a.pageX-j.left||0,q=a.pageY-j.top||0,r=this._change[k],s=this.size.width,t=this.size.height;if(!r)return!1;var u=Math.cos(g),v=Math.sin(g);ndx=p*u+q*v,ndy=q*u-p*v,p=ndx,q=ndy,e=r.apply(this,[a,p,q]),this._updateVirtualBoundaries(a.shiftKey),(this._aspectRatio||a.shiftKey)&&(e=this._updateRatio(e,a)),e=this._respectSize(e,a);var w={left:this.position.left,top:this.position.top};this._updateCache(e),this.position={left:w.left,top:w.top};var x={left:c(e.left||this.lastData.left)-c(this.lastData.left),top:c(e.top||this.lastData.top)-c(this.lastData.top)},y={};y.left=x.left*u-x.top*v,y.top=x.top*u+x.left*v,y.left=d(y.left),y.top=d(y.top),this.position.left+=y.left,this.position.top+=y.top,this.lastData={left:c(e.left||this.lastData.left),top:c(e.top||this.lastData.top)},this._propagate("resize",a);var z=s-this.size.width,A=t-this.size.height,B=$.getCorrection(s,t,z,A,f);return this.position.left+=B.left,this.position.top-=B.top,this.position.top!==l&&(i.top=this.position.top+"px"),this.position.left!==m&&(i.left=this.position.left+"px"),this.size.width!==n&&(i.width=this.size.width+"px"),this.size.height!==o&&(i.height=this.size.height+"px"),h.css(i),!this._helper&&this._proportionallyResizeElements.length&&this._proportionallyResize(),$.isEmptyObject(i)||this._trigger("resize",a,this.ui()),!1},jQuery(e).resizable({ghost:!0,handles:"sw, se, nw, ne",helper:"resizable-helper",aspectRatio:!1,stop:function(a,b){h.ctx.clearRect(0,0,h.ctx.canvas.width,h.ctx.canvas.height),h.width=b.size.width,h.height=b.size.height,h.setCanvasSize(),h.ctx.save(),h.ctx.translate(h.ctx.canvas.width/2,h.ctx.canvas.height/2),h.ctx.drawImage(h.image_,-(h.width/2),-(h.height/2),h.width,h.height),h.ctx.restore()}}).rotatable({stop:function(a,b){}}),jQuery(e).draggable({stop:function(a,b){if(null!=f){var c=$(this).position().left,d=$(this).position().top;h.latlng=f.fromDivPixelToLatLng(new google.maps.Point(c,d),!0)}}});var i=document.createElement("canvas");i.id="canvas",e.appendChild(i),this.div_=e,this.canvas=i,this.ctx=i.getContext("2d"),this.initImage();var j=this.getPanes();return j.overlayImage.appendChild(this.div_),this},CanvasOverlay.prototype.draw=function(){this.div_;null==this.canvas&&alert("error creating the canvas")},CanvasOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_)},CanvasOverlay.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},CanvasOverlay.prototype.show=function(){this.div_&&(this.div_.style.visibility="visible")},CanvasOverlay.prototype.toggle=function(){this.div_&&("hidden"==this.div_.style.visibility?this.show():this.hide())},CanvasOverlay.prototype.toggleDOM=function(){this.getMap()?this.setMap(null):this.setMap(this.map_)},CanvasOverlay.prototype.getCanvas=function(){return this.canvas},CanvasOverlay.prototype.getContext2d=function(){return this.ctx},CanvasOverlay.prototype.setCanvasSize=function(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.div_.style.width=this.width+"px",this.div_.style.height=this.height+"px"},CanvasOverlay.prototype.initImage=function(){this.setCanvasSize(),this.ctx.save(),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.rotate(this.angle),this.ctx.drawImage(this.image_,-(this.width/2),-(this.height/2),this.width,this.height),this.ctx.restore()},CanvasOverlay.prototype.drawBoundingCanvas=function(){var a=getRotationDegrees($("#canvas_editor")),b=deg2rad(a);$("#canvas_editor").css({"-moz-transform":"rotate(0deg)","-webkit-transform":"rotate(0deg)","-ms-transform":"rotate(0deg)","-o-transform":"rotate(0deg)",transform:"rotate(0deg)"});var c=getPositionData($("#canvas_editor")),d=c.left,e=c.top,f=d+this.width/2,g=e+this.height/2,h=f+(d-f)*Math.cos(b)+(e-g)*Math.sin(b),i=g-(d-f)*Math.sin(b)+(e-g)*Math.cos(b),j=f+(d+this.width-f)*Math.cos(b)+(e-g)*Math.sin(b),k=g-(d+this.width-f)*Math.sin(b)+(e-g)*Math.cos(b),l=f+(d-f)*Math.cos(b)+(e+this.height-g)*Math.sin(b),m=g-(d-f)*Math.sin(b)+(e+this.height-g)*Math.cos(b),n=f+(d+this.width-f)*Math.cos(b)+(e+this.height-g)*Math.sin(b),o=g-(d+this.width-f)*Math.sin(b)+(e+this.height-g)*Math.cos(b),p=Math.max(h,j,l,n),q=Math.max(i,k,m,o),r=Math.min(h,j,l,n),s=Math.min(i,k,m,o),t=s,u=r,v=p-r,w=q-s;$("#canvas_editor").css({top:t+"px",left:u+"px"}),this.ctx.canvas.width=v,this.ctx.canvas.height=w,this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.translate(f-u,g-t),this.ctx.rotate(b),this.ctx.drawImage(this.image_,-(this.width/2),-(this.height/2),this.width,this.height),this.ctx.restore(),this.top=t,this.left=u;var x;null!=(x=this.getProjection())&&(this.bottom_left_coords=x.fromContainerPixelToLatLng(new google.maps.Point(this.left,this.top+w),!0),this.top_right_coords=x.fromContainerPixelToLatLng(new google.maps.Point(this.left+v,this.top),!0))};var getPositionData=function(a){return $.extend({width:a.outerWidth(!1),height:a.outerHeight(!1)},a.offset())},LPUtils={};LPUtils.isNullOrUndefined=function(a){return"undefined"==typeof a||null===a},LPUtils.isStringEmptyNullUndefined=function(a){return!a||0===a.length},LPUtils.isStringBlankNullUndefined=function(a){return!a||/^\s*$/.test(a)},LPUtils.alert=function(a){var b=document.getElementById("notification_panel");b.innerHTML='<alert type="error" close="LPUtils.closeAlert()">'+a+"</alert>"},LPUtils.closeAlert=function(){var a=document.getElementById("notification_panel");a.getEl.innerHTML=""},LPUtils.success=function(a){var b=document.getElementById("notification_panel");b.innerHTML='<alert type="success">'+a+"</alert>"},LPUtils.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=LPUtils.Base64._utf8_encode(a);j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)e=this._keyStr.indexOf(a.charAt(j++)),f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,i+=String.fromCharCode(b),64!=g&&(i+=String.fromCharCode(c)),64!=h&&(i+=String.fromCharCode(d));return i=LPUtils.Base64._utf8_decode(i)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):d>191&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((31&d)<<6|63&c2),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((15&d)<<12|(63&c2)<<6|63&c3),c+=3);return b}},LPUtils.Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=a.length/4*3,c=new ArrayBuffer(b);return this.decode(a,c),c},decode:function(a,b){var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-2)),e=a.length/4*3;64==c&&e--,64==d&&e--;var f,g,h,i,j,k,l,m,n=0,o=0;for(f=b?new Uint8Array(b):new Uint8Array(e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),n=0;e>n;n+=3)j=this._keyStr.indexOf(a.charAt(o++)),k=this._keyStr.indexOf(a.charAt(o++)),l=this._keyStr.indexOf(a.charAt(o++)),m=this._keyStr.indexOf(a.charAt(o++)),g=j<<2|k>>4,h=(15&k)<<4|l>>2,i=(3&l)<<6|m,f[n]=g,64!=l&&(f[n+1]=h),64!=m&&(f[n+2]=i);return f}},USGSOverlay.prototype=new google.maps.OverlayView,USGSOverlay.prototype.onAdd=function(){var a=document.createElement("div");a.id="ground_overlay",a.style.borderStyle="none",a.style.borderWidth="0px",a.style.position="absolute";var b=document.createElement("img");b.src=this.image64,b.style.width="100%",b.style.height="100%",b.style.position="absolute",a.appendChild(b),this.div_=a;var c=this.getPanes();c.overlayLayer.appendChild(a)},USGSOverlay.prototype.draw=function(){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.bounds_.getSouthWest()),c=a.fromLatLngToDivPixel(this.bounds_.getNorthEast()),d=this.div_;d.style.left=b.x+"px",d.style.top=c.y+"px",d.style.width=c.x-b.x+"px",d.style.height=b.y-c.y+"px"},USGSOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},app.controller("AlertController",["$rootScope","$scope","AnyplaceService",function(a,b,c){b.anyService=c,b.alerts=c.alerts,b.closeable=!0}]),app.controller("BuildingController",["$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(a,b,c,d,e){a.myMarkers={},a.myMarkerId=0,a.gmapService=c,a.anyService=d,a.anyAPI=e,a.myBuildings=[],a.myBuildingsHashT={},a.crudTabSelected=1,a.setCrudTabSelected=function(b){if(a.crudTabSelected=b,!a.anyService.getBuilding())return void g("No building is selected.");var c=a.myBuildingsHashT[a.anyService.getBuildingId()];if(c){var d=c.marker;d&&(2===b?d.setDraggable(!0):d.setDraggable(!1))}},a.isCrudTabSelected=function(b){return a.crudTabSelected===b},a.$on("loggedIn",function(b,c){a.fetchAllBuildings()}),a.$on("loggedOff",function(b,c){f(),a.myMarkers={},a.myMarkerId=0,a.myBuildings=[],a.myBuildingsHashT={}}),a.$watch("anyService.selectedBuilding",function(b,c){b&&b.coordinates_lat&&b.coordinates_lon&&(a.gmapService.gmap.panTo(i(b)),a.gmapService.gmap.setZoom(19),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastBuilding",b.buid))});var f=function(){for(var b in a.myBuildingsHashT)a.myBuildingsHashT.hasOwnProperty(b)&&(a.myBuildingsHashT[b].marker.setMap(null),delete a.myBuildingsHashT[b])},g=function(b){a.anyService.addAlert("danger",b)},h=function(b){a.anyService.addAlert("success",b)},i=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0};a.fetchAllBuildings=function(){var b={};if(b.username=a.creds.username,b.password=a.creds.password,b.owner_id=a.owner_id,!b.owner_id)return void g("Could nor authorize user. Please refresh.");var d=a.anyAPI.allBuildings(b);d.then(function(b){var d=b.data;a.myBuildings=d.buildings;var e=new google.maps.InfoWindow({content:"-",maxWidth:500}),f=-1,g=void 0;"undefined"!=typeof Storage&&localStorage&&localStorage.getItem("lastBuilding")&&(g=localStorage.getItem("lastBuilding"));for(var h=0;h<a.myBuildings.length;h++){var j=a.myBuildings[h];g&&g===j.buid&&(f=h),"true"===j.is_published||1==j.is_published?j.is_published=!0:j.is_published=!1;var k=new google.maps.Marker({position:i(j),map:c.gmap,icon:new google.maps.MarkerImage("build/images/building-icon.png",null,null,null,new google.maps.Size(54,54)),draggable:!1}),l='<div class="infowindow-scroll-fix"><h5 style="margin: 0">Building:</h5><span>'+j.name+'</span><h5 style="margin: 8px 0 0 0">Description:</h5><span>'+j.description+"</span></div>";k.infoContent=l,k.building=j,a.myBuildingsHashT[j.buid]={marker:k,model:j},google.maps.event.addListener(k,"click",function(){e.setContent(this.infoContent),e.open(c.gmap,this);var b=this;a.$apply(function(){a.anyService.selectedBuilding=b.building})})}f>=0?a.anyService.selectedBuilding=a.myBuildings[f]:a.myBuildings[0]&&(a.anyService.selectedBuilding=a.myBuildings[0])},function(a){a.data;g("Something went wrong while fetching buildings.")})},a.addNewBuilding=function(b){if(a.myMarkers[b]&&a.myMarkers[b].marker){var c=a.myMarkers[b].model;if(c.owner_id=a.owner_id,!c.owner_id)return void g("Could not authorize user. Please refresh.");if(c.coordinates_lat=String(a.myMarkers[b].marker.position.lat()),c.coordinates_lon=String(a.myMarkers[b].marker.position.lng()),void 0===c.coordinates_lat||null===c.coordinates_lat)return void g("Invalid building latitude.");if(void 0===c.coordinates_lon||null===c.coordinates_lon)return void g("Invalid building longitude.");if(c.is_published===!0?c.is_published="true":c.is_published="false",c.description||(c.description="-"),c.owner_id&&c.name&&c.description&&c.is_published&&c.url&&c.address){var d=a.anyAPI.addBuilding(c);d.then(function(d){var e=d.data;console.log("new buid: "+e.buid),c.buid=e.buid,"true"===c.is_published||1==c.is_published?c.is_published=!0:c.is_published=!1,a.myBuildings.push(c),a.anyService.selectedBuilding=a.myBuildings[a.myBuildings.length-1],a.myMarkers[b].marker.setDraggable(!1),a.myBuildingsHashT[c.buid]={marker:a.myMarkers[b].marker,model:c},a.myMarkers[b].infowindow&&(a.myMarkers[b].infowindow.setContent(a.myMarkers[b].marker.tpl2[0]),a.myMarkers[b].infowindow.close()),h("Building added successfully.")},function(a){var b=a.data;g("Something went wrong while adding the building. "+b.message)})}else g("Some required fields are missing.")}},a.deleteBuilding=function(){var b=a.anyService.getBuilding(),c=a.creds;if(!a.owner_id)return void g("Could not identify user. Please refresh and sign in again.");if(c.owner_id=a.owner_id,!b||!b.buid)return void g("No building selected for deletion.");c.buid=b.buid;var d=a.anyAPI.deleteBuilding(c);d.then(function(c){c.data;console.log("building deleted: ",b),a.myBuildingsHashT[b.buid].marker.setMap(null),delete a.myBuildingsHashT[b.buid];for(var d=a.myBuildings,e=d.length,f=0;e>f;f++)if(d[f].buid==b.buid){d.splice(f,1);break}a.myBuildings&&a.myBuildings.length>0&&(a.anyService.selectedBuilding=a.myBuildings[0]),a.setCrudTabSelected(1),h("Successfully deleted building.")},function(a){a.data;g("Something went wrong. It's likely that everything related to the building is deleted but please refresh to make sure or try again.")})},a.updateBuilding=function(){var b=a.anyService.getBuilding();if(LPUtils.isNullOrUndefined(b)||LPUtils.isNullOrUndefined(b.buid))return void g("No building selected found.");var c={};if(c=a.creds,!a.owner_id)return void g("Could not identify user. Please refresh and sign in again.");c.owner_id=a.owner_id,c.buid=b.buid,b.description&&(c.description=b.description),b.name&&(c.name=b.name),b.is_published===!0||"true"==b.is_published?c.is_published="true":c.is_published="false",b.bucode&&(c.bucode=b.bucode);var d=a.myBuildingsHashT[b.buid].marker;if(d){var e=d.position;e&&e.lat()&&e.lng()&&(c.coordinates_lat=String(e.lat()),c.coordinates_lon=String(e.lng()))}var f=a.anyAPI.updateBuilding(c);f.then(function(a){a.data;"true"===b.is_published||1==b.is_published?b.is_published=!0:b.is_published=!1,h("Successfully updated building.")},function(a){var b=a.data;g("Something went wrong while updating building. "+b.message)})};var j=new google.maps.OverlayView;j.draw=function(){},j.setMap(c.gmap),$("#draggable-building").draggable({helper:"clone",stop:function(b){var c=new google.maps.Point(b.pageX,b.pageY),d=j.getProjection().fromContainerPixelToLatLng(c);a.placeMarker(d)}}),a.placeMarker=function(d){var e=a.myMarkers[a.myMarkerId-1];if(e&&e.marker&&e.marker.getMap()&&e.marker.getDraggable())return void console.log("there is a building pending, please add 1 at a time");var f=new google.maps.Marker({position:d,map:c.gmap,icon:"build/images/building-icon.png",draggable:!0}),g=new google.maps.InfoWindow({content:"-",maxWidth:500});a.$apply(function(){f.myId=a.myMarkerId,a.myMarkers[f.myId]={},a.myMarkers[f.myId].model={description:"",name:void 0,is_published:!0,address:"-",url:"-",bucode:""},a.myMarkers[f.myId].marker=f,a.myMarkers[f.myId].infowindow=g,a.myMarkerId++});var h='<form name="buildingForm" class="infowindow-scroll-fix"><fieldset class="form-group"><input ng-model="myMarkers['+f.myId+'].model.bucode" id="building-code" type="text" class="form-control" placeholder="Building Code (Optional)"/></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+f.myId+'].model.name" id="building-name" type="text" class="form-control" placeholder="Building Name *"/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+f.myId+'].model.description" id="building-description" type="text" class="form-control" placeholder="Building Description (Optional)"></textarea></fieldset><fieldset class="form-group"><input ng-model="myMarkers['+f.myId+'].model.is_published" id="building-published" type="checkbox"><span> Make building public to view.</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addNewBuilding('+f.myId+')"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempBuilding('+f.myId+')"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div></form>',i='<div class="infowindow-scroll-fix"><h5 style="margin: 0">Building:</h5><span>{{myMarkers['+f.myId+'].model.name}}</span><h5 style="margin: 8px 0 0 0">Description:</h5><span>{{myMarkers['+f.myId+"].model.description}}</span></div>",j=b(h)(a);f.tpl2=b(i)(a),g.setContent(j[0]),g.open(c.gmap,f),google.maps.event.addListener(f,"click",function(){g.getMap()||g.open(c.gmap,f)})},a.deleteTempBuilding=function(b){var c=a.myMarkers[b];c&&c.marker&&c.marker.setMap(null)},a.exportBuildingToJson=function(){var b={building:{floors:[]}},c=a.anyService.selectedBuilding;if(LPUtils.isNullOrUndefined(c))return void g("No building selected");b.building.name=c.name,b.building.description=c.description,b.building.coordinates_lat=c.coordinates_lat,b.building.coordinates_lon=c.coordinates_lon;
var f=d.jsonReq;f.buid=c.buid;var i=0,j=e.allBuildingFloors(f);j.then(function(a){var d=a.data.floors,f=[];if(d)for(var g=0;g<d.length;g++)!function(a){var g=e.retrievePoisByBuildingFloor(a);g.then(function(a){var e=a.data,g=e.pois;if(g){for(var j=[],k=g[0].floor_number,l=0;l<g.length;l++){var m=g[l];if("None"!=m.pois_type){var n={name:m.name,description:m.description,pois_type:m.pois_type,coordinates_lat:m.coordinates_lat,coordinates_lon:m.coordinates_lon};m.is_building_entrance&&(n.is_building_entrance="true"),j.push(n)}}if(f.push({floor_number:k,pois:j}),i++,i===d.length){b.building.floors=f,h("Successfully exported "+c.name+" to JSON.");var o=new Blob([JSON.stringify(b,null,4)],{type:"text/plain;charset=utf-8"});saveAs(o,c.name.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")+".txt")}}},function(a){var b=a.data;console.log(b.message)})}({buid:c.buid,floor_number:d[g].floor_number})},function(a){console.log(a.data.message)})}}]),app.controller("ControlBarController",["$scope","$rootScope","AnyplaceService","AnyplaceAPIService",function(a,b,c,d){a.isAuthenticated=!1,a.signInType="google",a.gAuth={},a.person=void 0,a.creds={username:"username",password:"password"},a.owner_id=void 0,a.displayName=void 0,a.setAuthenticated=function(b){a.isAuthenticated=b},a.showFullControls=!0,a.toggleFullControls=function(){a.showFullControls=!a.showFullControls};var e=function(){gapi.client.plus.people.get({userId:"me"}).execute(f)},f=function(b){a.personLookUp(b)};a.showGoogleID=function(){a.person&&c.addAlert("success","Your Google ID is: "+a.person.id)},a.showGoogleAuth=function(){a.gAuth&&c.addAlert("success","access_token: "+a.gAuth.access_token)},a.signinCallback=function(b){b.status.signed_in?(a.setAuthenticated(!0),a.gAuth=b,app.access_token=b.access_token,gapi.client.load("plus","v1",e)):console.log("Sign-in state: "+b.error)},a.personLookUp=function(b){a.person=b,a.owner_id=a.person.id+"_"+a.signInType,a.displayName=a.person.displayName,a.person&&a.person.id&&a.$broadcast("loggedIn",[]);var c=d.signAccount({name:a.person.displayName,type:"google"});c.then(function(a){},function(a){})},a.signOut=function(){gapi.auth.signOut(),a.isAuthenticated=!1,a.$broadcast("loggedOff",[]),a.gAuth={},a.owner_id=void 0,a.person=void 0},a.tab=1,a.setTab=function(b){a.tab=b},a.isTabSet=function(b){return a.tab===b}}]),app.controller("FloorController",["$scope","AnyplaceService","GMapService","AnyplaceAPIService",function(a,b,c,d){a.anyService=b,a.anyAPI=d,a.gmapService=c,a.xFloors=[],a.myFloors={},a.myFloorId=0,a.newFloorNumber=0;var e;a.crudTabSelected=1,a.setCrudTabSelected=function(b){a.crudTabSelected=b},a.isCrudTabSelected=function(b){return a.crudTabSelected===b},a.data={floor_plan_coords:{},floor_plan_base64_data:{},floor_plan_groundOverlay:null},a.$on("loggedOff",function(a,b){f()});var f=function(){a.removeFloorPlan(),a.xFloors=[],a.myFloorId=0,a.myFloors={}};a.$watch("anyService.selectedBuilding",function(b,c){b&&(e&&e.setMap(null),a.fetchAllFloorsForBuilding(b))}),a.$watch("newFloorNumber",function(a,b){});var g=function(b){a.anyService.addAlert("danger",b)},h=function(b){a.anyService.addAlert("success",b)},i=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0};a.$watch("anyService.selectedFloor",function(b,d){void 0!==b&&null!==b&&(a.fetchFloorPlanOverlay(b),c.gmap.panTo(i(a.anyService.selectedBuilding)),c.gmap.setZoom(19),e&&e.setMap(null),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastFloor",b.floor_number))}),a.orderByFloorNo=function(a){return!a||LPUtils.isNullOrUndefined(a.floor_number)?0:parseInt(a.floor_number)},a.fetchAllFloorsForBuilding=function(c){var e=b.jsonReq;e.buid=c.buid;var f=d.allBuildingFloors(e);f.then(function(b){a.xFloors=b.data.floors;var c=!1;if("undefined"!=typeof Storage&&localStorage&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor")))for(var d=0;d<a.xFloors.length;d++)if(String(a.xFloors[d].floor_number)===String(localStorage.getItem("lastFloor"))){a.anyService.selectedFloor=a.xFloors[d],c=!0;break}!c&&a.xFloors[0]&&(a.anyService.selectedFloor=a.xFloors[0]),j()},function(a){console.log(a.data.message),g("Something went wrong while fetching all floors")})};var j=function(){for(var b=-1,c=0;c<a.xFloors.length;c++)parseInt(a.xFloors[c].floor_number)>=b&&(b=parseInt(a.xFloors[c].floor_number));a.newFloorNumber=b+1},k=function(a){return null===a||void 0==a?!1:null===a.floor_number||void 0===a.floor_number?!1:!0};a.fetchFloorPlanOverlay=function(){if(!k(this.anyService.selectedFloor))return void console.log("something is wrong with the floor");var b=this.anyService.selectedFloor.floor_number,e=this.anyService.selectedBuilding.buid,f=d.downloadFloorPlan(this.anyService.jsonReq,e,b);f.then(function(b){a.data.floor_plan_file=null,a.data.floor_plan=null,null!=a.data.floor_plan_groundOverlay&&(a.data.floor_plan_groundOverlay.setMap(null),a.data.floor_plan_groundOverlay=null);var d=b.data,e=a.anyService.selectedFloor,f=new google.maps.LatLngBounds(new google.maps.LatLng(e.bottom_left_lat,e.bottom_left_lng),new google.maps.LatLng(e.top_right_lat,e.top_right_lng));a.data.floor_plan_groundOverlay=new USGSOverlay(f,"data:image/png;base64,"+d,c.gmap)},function(a){console.log("error downloading floor plan")})};var l=null;a.isCanvasOverlayActive=!1;var m=$("#input-floor-plan");m.change(function(b){var d=new FileReader;d.onload=function(b){var d=new Image;d.src=b.target.result,d.onload=function(){l=new CanvasOverlay(d,c.gmap),a.$apply(a.isCanvasOverlayActive=!0),a.data.floor_plan_groundOverlay&&a.data.floor_plan_groundOverlay.getMap()&&a.data.floor_plan_groundOverlay.setMap(null)}},d.readAsDataURL(b.target.files[0]),this.disabled=!0}),a.setFloorPlan=function(){if(l){(null===b.getBuildingId()||void 0===b.getBuildingId())&&(console.log("building is undefined"),g("Something went wrong. It seems like there is no building selected"));var d={is_published:"true",buid:String(b.getBuildingId()),floor_name:String(a.newFloorNumber),description:String(a.newFloorNumber),floor_number:String(a.newFloorNumber)};a.myFloors[a.myFloorId]=d,a.myFloorId++,l.drawBoundingCanvas();var e=l.bottom_left_coords,f=l.top_right_coords;a.data.floor_plan_coords.bottom_left_lat=e.lat(),a.data.floor_plan_coords.bottom_left_lng=e.lng(),a.data.floor_plan_coords.top_right_lat=f.lat(),a.data.floor_plan_coords.top_right_lng=f.lng();var h=l.getCanvas().toDataURL("image/png");a.data.floor_plan_base64_data=h;var i=new google.maps.LatLngBounds(new google.maps.LatLng(e.lat(),e.lng()),new google.maps.LatLng(f.lat(),f.lng()));if(a.data.floor_plan_groundOverlay=new USGSOverlay(i,h,c.gmap),l.setMap(null),$("#input-floor-plan").prop("disabled",!1),a.isCanvasOverlayActive=!1,o(a.newFloorNumber))for(var j=0;j<a.xFloors.length;j++){var k=a.xFloors[j];if(!LPUtils.isNullOrUndefined(k)&&k.floor_number===String(a.newFloorNumber)){a.uploadFloorPlanBase64(a.anyService.selectedBuilding,k,a.data);break}}else a.addFloorObject(d,a.anyService.selectedBuilding,a.data)}};var n=function(a){return a=null===a?{}:JSON.parse(JSON.stringify(a)),LPUtils.isNullOrUndefined(a.buid)&&(a.buid=""),LPUtils.isNullOrUndefined(a.floor_name)&&(a.floor_name=""),LPUtils.isNullOrUndefined(a.floor_number)&&(a.floor_number=""),LPUtils.isNullOrUndefined(a.description)&&(a.description=""),LPUtils.isNullOrUndefined(a.is_published)&&(a.is_published="true"),a};a.addFloorObject=function(b,c,d){var e=n(b);if(e.owner_id=a.owner_id,!e.owner_id)return void g("Could not authorize user. Please refresh.");var f=a.anyAPI.addFloor(e);f.then(function(b){b.data;a.xFloors.push(e),a.anyService.selectedFloor=a.xFloors[a.xFloors.length-1],h("Successfully added new floor"),a.uploadFloorPlanBase64(c,e,d)},function(a){var b=a.data;console.log(b.message),g("Something went wrong while adding a new floor.")})},a.removeFloorPlan=function(){a.data.floor_plan_file=null,a.data.floor_plan=null,l&&l.setMap(null),a.data.floor_plan_groundOverlay&&a.data.floor_plan_groundOverlay.setMap(a.gmapService.gmap);var b=$("#input-floor-plan");b.replaceWith(b=b.clone(!0)),b.prop("disabled",!1),a.isCanvasOverlayActive=!1},a.deleteFloor=function(){var b=a.anyService.getFloor();if(LPUtils.isNullOrUndefined(b)||LPUtils.isStringBlankNullUndefined(b.floor_number)||LPUtils.isStringBlankNullUndefined(b.buid))return void g("No floor seems to be selected.");b.username=a.creds.username,b.password=a.creds.password,b.owner_id=a.owner_id,console.log(b);var c=a.anyAPI.deleteFloor(b);c.then(function(c){for(var d=(c.data,a.xFloors),e=d.length,f=0;e>f;f++)if(d[f].floor_number==b.floor_number){d.splice(f,1);break}null!=a.data.floor_plan_groundOverlay&&(a.data.floor_plan_groundOverlay.setMap(null),a.data.floor_plan_groundOverlay=null),a.xFloors&&a.xFloors.length>0?a.anyService.selectedFloor=a.xFloors[0]:a.anyService.selectedFloor=void 0,h("Successfully deleted floor.")},function(a){a.data;g("Something went wrong while deleting the floor.")})};var o=function(b){for(var c=0;c<a.xFloors.length;c++){var d=a.xFloors[c];if(!LPUtils.isNullOrUndefined(d)&&d.floor_number===String(b))return!0}return!1},p=function(a){if(LPUtils.isNullOrUndefined(a))return{};var b=JSON.parse(JSON.stringify(a));return b};a.uploadFloorPlanBase64=function(b,c,d){if(!LPUtils.isNullOrUndefined(l)){var e=p(d.floor_plan_coords);if(LPUtils.isNullOrUndefined(e)||LPUtils.isStringBlankNullUndefined(e.bottom_left_lat)||LPUtils.isStringBlankNullUndefined(e.bottom_left_lng)||LPUtils.isStringBlankNullUndefined(e.top_right_lat)||LPUtils.isStringBlankNullUndefined(e.top_right_lng))return console.log("error with floor coords"),void g("Something went wrong. It seems like no valid coordinates have been set up for this floor plan.");if(e.bottom_left_lat=String(e.bottom_left_lat),e.bottom_left_lng=String(e.bottom_left_lng),e.top_right_lat=String(e.top_right_lat),e.top_right_lng=String(e.top_right_lng),c.bottom_left_lat=e.bottom_left_lat,c.bottom_left_lng=e.bottom_left_lng,c.top_right_lat=e.top_right_lat,c.top_right_lng=e.top_right_lng,LPUtils.isNullOrUndefined(b))return void g("Something went wrong. It seems like there is no building selected.");if(LPUtils.isNullOrUndefined(b.buid))return void g("Something went wrong with the selected building's id.");if(e.buid=b.buid,LPUtils.isNullOrUndefined(c))return void g("Something went wrong. It seems there is no floor selected.");if(LPUtils.isNullOrUndefined(c.floor_number))return void g("Something went wrong. It seems there is no floor number associated with the selected floor.");e.floor_number=c.floor_number,e.owner_id=a.owner_id;var f=JSON.stringify(e);if(LPUtils.isNullOrUndefined(d.floor_plan_base64_data)||LPUtils.isStringEmptyNullUndefined(d.floor_plan_base64_data))return void console.log("no floor plan file");var i=a.anyAPI.uploadFloorPlan64(f,a.data.floor_plan_base64_data);i.then(function(a){a.data;h("Successfully uploaded new floor plan.")},function(a){a.data;h("Successfully uploaded new floor plan.")})}},a.toggleRadioHeatmap=function(){return e&&e.getMap()?void e.setMap(null):void a.showRadioHeatmap()},a.getHeatMapButtonText=function(){return e&&e.getMap()?"Hide WiFi Map":"Show WiFi Map"},a.showRadioHeatmap=function(){var b={};b.username=a.creds.username,b.password=a.creds.password,b.buid=a.anyService.getBuildingId(),b.floor=a.anyService.getFloorNumber();var c=a.anyAPI.getRadioHeatmap(b);c.then(function(b){var c=(b.data,[]),d=b.data.radioPoints.length;if(0>=d)return void g("This floor seems not to be WiFi mapped. Download the Anyplace app from the Google Play store to map the floor.");for(;d--;){var f=b.data.radioPoints[d];c.push({location:new google.maps.LatLng(f.x,f.y),weight:1}),b.data.radioPoints.splice(d,1)}e&&e.getMap()&&e.setMap(null),e=new google.maps.visualization.HeatmapLayer({data:c}),e.setMap(a.gmapService.gmap)},function(a){a.data;g("Something went wrong while fetching radio heatmap.")})}}]),app.controller("PoiController",["$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(a,b,c,d,e){a.anyService=d,a.anyAPI=e,a.myMarkers={},a.myMarkerId=0,a.myPaths={},a.myPathId=0,a.myPois=[],a.myPoisHashT={},a.myConnectionsHashT={},a.poisTypes=["Disabled Toilets","Elevator","Entrance","Fire Extinguisher","First Aid/AED","Kitchen","Office","Ramp","Room","Security/Guard","Stair","Toilets","Other"],a.edgeMode=!1,a.connectPois={prev:void 0,next:void 0},a.orderByName=function(a){return a.name},a.$on("loggedOff",function(b,c){a.clearConnectionsOnMap(),a.clearPoisOnMap(),a.myPaths={},a.myPathId=0,a.myMarkers={},a.myMarkerId=0,a.myPois=[],a.myPoisHashT={},a.myConnectionsHashT={},a.edgeMode=!1,a.connectPois={prev:void 0,next:void 0}}),a.$watch("anyService.selectedFloor",function(b,c){void 0!==b&&null!==b?a.fetchAllPoisForFloor(b):a.anyService.selectedPoi=void 0}),a.$watch("anyService.selectedPoi",function(b,d){if(b&&i(b)&&b&&(c.gmap.panTo(i(b)),b.puid)){var e=a.myPoisHashT[b.puid].marker;e&&e.infowindow&&e.tpl2&&(e.infowindow.setContent(e.tpl2[0]),e.infowindow.open(c.gmap,e)),"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastPoi",b.puid)}}),a.onInfoWindowKeyDown=function(b){if(27==b.keyCode&&a.anyService.selectedPoi){var c=a.anyService.selectedPoi;a.myPoisHashT[c.puid]&&a.myPoisHashT[c.puid].marker&&a.myPoisHashT[c.puid].marker.infowindow&&a.myPoisHashT[c.puid].marker.infowindow.setMap(null)}},a.clearPoisOnMap=function(){for(var b=0;b<a.myPois.length;b++){var c=a.myPois[b];c&&a.myPoisHashT[c.puid]&&a.myPoisHashT[c.puid].marker&&(a.myPoisHashT[c.puid].marker.setMap(null),delete a.myPoisHashT[c.puid])}},a.clearConnectionsOnMap=function(){if(a.myConnectionsHashT)for(var b in a.myConnectionsHashT)b&&a.myConnectionsHashT.hasOwnProperty(b)&&a.myConnectionsHashT[b]&&a.myConnectionsHashT[b].polyLine&&a.myConnectionsHashT[b].polyLine.setMap(null)},a.fetchConnections=function(){var b,c,d=a.anyService.jsonReq,e=a.anyService.getBuilding();if(LPUtils.isNullOrUndefined(e))return void j("No building has been selected!");if(LPUtils.isNullOrUndefined(e.buid))return void j("No valid building has been selected!");b=a.anyService.getBuildingId();var f=a.anyService.getFloor();if(LPUtils.isNullOrUndefined(f))return void j("No floor has been selected!");if(LPUtils.isNullOrUndefined(f.floor_number))return void j("No valid floor has been selected!");if(c=a.anyService.getFloorNumber(),d.buid=b,d.floor_number=c,(LPUtils.isNullOrUndefined(a.myPois)||LPUtils.isNullOrUndefined(a.myPoisHashT))&&j("Please load the POIs of this floor first."),0!=a.myPois.length){var g=d,h=a.anyAPI.retrieveConnectionsByBuildingFloor(g);h.then(function(b){for(var c=b.data,d=c.connections,e={},f=d.length,g=0;f>g;g++)e[d[g].cuid]=d[g];a.myConnectionsHashT=e,a.drawConnectionsOnMap()},function(a){a.data;j("Something went wrong while loading the POI connections")})}},a.drawConnectionsOnMap=function(){for(var b in a.myConnectionsHashT)if(a.myConnectionsHashT.hasOwnProperty(b)){var d=a.myConnectionsHashT[b];if(!(d&&d.pois_a&&d.pois_b&&a.myPoisHashT[d.pois_a]&&a.myPoisHashT[d.pois_b]&&a.myPoisHashT[d.pois_a].model&&a.myPoisHashT[d.pois_b].model))continue;var e=[new google.maps.LatLng(a.myPoisHashT[d.pois_a].model.coordinates_lat,a.myPoisHashT[d.pois_a].model.coordinates_lon),new google.maps.LatLng(a.myPoisHashT[d.pois_b].model.coordinates_lat,a.myPoisHashT[d.pois_b].model.coordinates_lon)],f=new google.maps.Polyline({path:e,strokeColor:"#0000FF",strokeOpacity:.5,strokeWeight:4});f.setMap(c.gmap),f.model=d,a.myConnectionsHashT[b].polyLine=f,google.maps.event.addListener(f,"click",function(){a.$apply(s(this))})}};var f="build/images/edge-connector-icon.png",g="build/images/any-poi-icon.png",h="build/images/poi-icon.png",i=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0},j=function(b){a.anyService.addAlert("danger",b)},k=function(b){a.anyService.addAlert("success",b)},l=function(b){a.anyService.addAlert("warning",b)},m=function(b){var c=.001,d=b.lat(),e=b.lng(),f=a.anyService.getFloor();if(LPUtils.isNullOrUndefined(f))return j("No selected floor found."),!1;var g=f.top_right_lat,h=f.top_right_lng,i=f.bottom_left_lat,k=f.bottom_left_lng;return g&&h&&i&&k?d<=parseFloat(g)+c&&e<=parseFloat(h)+c&&d>=parseFloat(i)-c&&e>=parseFloat(k)-c:(j("Floor coordinates not found."),!1)};a.drawPoisOnMap=function(){var d=new google.maps.InfoWindow({content:"-",maxWidth:500}),e=void 0,h=-1;"undefined"==typeof Storage||!localStorage||LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastPoi"))||(e=localStorage.getItem("lastPoi"));for(var k=0;k<a.myPois.length;k++){var l=a.myPois[k];e&&l.puid===e&&(h=k);var m,r="-";if("None"==l.pois_type)m=new google.maps.Marker({position:i(l),map:c.gmap,draggable:!0,icon:new google.maps.MarkerImage(f,null,null,null,new google.maps.Size(21,21))}),r='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><fieldset class="form-group" style="display: inline-block; width: 73%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi(\''+l.puid+'\')"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi(\''+l.puid+'\')"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div>';else{var t=g,u=new google.maps.Size(21,32);m=new google.maps.Marker({position:i(l),map:c.gmap,draggable:!0,icon:new google.maps.MarkerImage(t,null,null,null,u)}),r='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><textarea ng-model="myPois['+k+'].name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus></textarea></fieldset><fieldset class="form-group"><textarea ng-model="myPois['+k+'].description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myPois['+k+'].pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><fieldset class="form-group"><input ng-model="myPois['+k+'].is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi(\''+l.puid+'\')" tabindex="3"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi(\''+l.puid+'\')" tabindex="6"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div></form></div>'}var v=b(r)(a);m.tpl2=v,m.model=l,m.infowindow=d,a.myPoisHashT[l.puid].marker=m,google.maps.event.addListener(m,"click",function(){if(a.edgeMode)if(a.connectPois.prev){if(a.connectPois.prev==this)return a.connectPois.prev=void 0,void("None"===this.model.pois_type?this.setIcon(o()):this.setIcon(q()));"None"===a.connectPois.prev.model.pois_type?a.connectPois.prev.setIcon(o()):a.connectPois.prev.setIcon(q());var b=new google.maps.Polyline({path:[this.position,a.connectPois.prev.position],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:4});b.setMap(c.gmap);var e=a.connectPois.prev.model,f=this.model;if(!(e&&f&&e.puid&&f.puid&&e.buid&&f.buid&&!LPUtils.isNullOrUndefined(e.floor_number)&&!LPUtils.isNullOrUndefined(f.floor_number)))return void j("One or both of the POIs attempted to be connected seem to be be malformed. Please refresh.");var g={username:a.creds.username,password:a.creds.password,owner_id:a.owner_id,pois_a:e.puid,floor_a:e.floor_number,buid_a:e.buid,buid:e.buid,pois_b:f.puid,floor_b:f.floor_number,buid_b:f.buid,is_published:"true",edge_type:"hallway"};b.model=g;var h=a.anyAPI.addConnection(g);h.then(function(c){var d=c.data,e=d.cuid;b.model.cuid=e;var f=b.model;f.polyLine=b,a.myConnectionsHashT[e]=f,b.setOptions({strokeColor:"#0000FF",strokeOpacity:.5}),google.maps.event.addListener(b,"click",function(){a.$apply(s(this))})},function(a){a.data;j("Something went wrong while attempting to connect the two POIs."),b.setMap(null)}),a.connectPois.prev=void 0}else a.connectPois.prev=this,"None"===this.model.pois_type?this.setIcon(n()):this.setIcon(p());else{d.setContent(this.tpl2[0]),d.open(c.gmap,this);var i=this;a.$apply(function(){i.model&&i.model.puid&&(a.anyService.selectedPoi=i.model)})}}),google.maps.event.addListener(m,"dragend",function(b){this.model&&this.model.puid&&a.updatePoiPosition(this)})}h>=0&&(a.anyService.selectedPoi=a.myPois[h]),a.fetchConnections()};var n=function(){return new google.maps.MarkerImage(f,null,null,null,new google.maps.Size(41,41))},o=function(){return new google.maps.MarkerImage(f,null,null,null,new google.maps.Size(21,21))},p=function(){return new google.maps.MarkerImage(g,null,null,null,new google.maps.Size(31,48))},q=function(){return new google.maps.MarkerImage(g,null,null,null,new google.maps.Size(21,32))},r=function(a){return null===a&&(a={}),LPUtils.isNullOrUndefined(a.buid)&&(a.buid=""),LPUtils.isNullOrUndefined(a.is_published)&&(a.is_published=!1),LPUtils.isNullOrUndefined(a.edge_type)&&(a.edge_type=""),LPUtils.isNullOrUndefined(a.pois_a)&&(a.pois_a=""),LPUtils.isNullOrUndefined(a.pois_b)&&(a.pois_b=""),LPUtils.isNullOrUndefined(a.floor_a)&&(a.floor_a=""),LPUtils.isNullOrUndefined(a.floor_b)&&(a.floor_b=""),LPUtils.isNullOrUndefined(a.buid_a)&&(a.buid_a=""),LPUtils.isNullOrUndefined(a.buid_b)&&(a.buid_b=""),a},s=function(b){if(!a.edgeMode)return void j('Enable "Edge Mode" so you can delete connections by clicking on them.');if(!b||!b.model||!b.model.cuid)return void j("No valid connection selected.");var d=b.model,e=b.model.cuid;if(!a.myConnectionsHashT[e])return void j("The connection attempted to delete does not exist in the system.");var f=r(d);if(f.username=a.creds.username,f.password=a.creds.password,f.owner_id=a.owner_id,LPUtils.isNullOrUndefined(f.pois_a)||LPUtils.isStringBlankNullUndefined(f.pois_a))return void j("No valid connection has been selected. Missing POI A.");if(LPUtils.isNullOrUndefined(f.pois_b)||LPUtils.isStringBlankNullUndefined(f.pois_b))return void j("No valid connection has been selected. Missing POI B.");b.setMap(null);var g=b.model.polyLine;delete b.model.polyLine;var h=a.anyAPI.deleteConnection(f);h.then(function(b){b.data;delete a.myConnectionsHashT[e]},function(a){a.data;b.setMap(c.gmap),b.model.polyLine=g,j("Something went wrong. Connection could not be deleted.")})};a.fetchAllPoisForFloor=function(b){var c=d.jsonReq;c.buid=d.getBuildingId(),c.floor_number=d.getFloorNumber();var f=e.retrievePoisByBuildingFloor(c);f.then(function(b){var c=b.data;a.clearPoisOnMap(),a.clearConnectionsOnMap(),a.myPois=c.pois;for(var d=a.myPois.length,e=d-1;e>=0;e--){var f=a.myPois[e].puid;"true"==a.myPois[e].is_building_entrance?a.myPois[e].is_building_entrance=!0:a.myPois[e].is_building_entrance=!1,a.myPoisHashT[f]={},a.myPoisHashT[f].model=a.myPois[e]}a.drawPoisOnMap()},function(a){a.data;j("Something went wrong while fetching POIs")})};var t=new google.maps.OverlayView;t.draw=function(){},t.setMap(c.gmap),a.addPoi=function(b){if(a.myMarkers[b]&&a.myMarkers[b].marker){var d=a.myMarkers[b].model;if(d.owner_id=a.owner_id,d.coordinates_lat=String(a.myMarkers[b].marker.position.lat()),d.coordinates_lon=String(a.myMarkers[b].marker.position.lng()),d.is_building_entrance=String(d.is_building_entrance),void 0===d.coordinates_lat||null===d.coordinates_lat)return void j("POI has invalid latitude format");if(void 0===d.coordinates_lon||null===d.coordinates_lon)return void j("POI has invalid longitude format");if(!(d.owner_id&&d.name&&d.buid&&d.pois_type)||LPUtils.isNullOrUndefined(d.is_building_entrance)||LPUtils.isNullOrUndefined(d.is_published)||LPUtils.isNullOrUndefined(d.is_door)||LPUtils.isNullOrUndefined(d.floor_name)||LPUtils.isNullOrUndefined(d.floor_number))j("Cannot add new POI. Some required fields are missing.");else{"true"==d.is_building_entrance?d.is_building_entrance="true":d.is_building_entrance="false";var e=d,f=a.anyAPI.addPois(e);f.then(function(e){var f=e.data;d.puid=f.puid,"true"==d.is_building_entrance?d.is_building_entrance=!0:d.is_building_entrance=!1,a.myPois.push(d),a.anyService.selectedPoi=a.myPois[a.myPois.length-1],a.myPoisHashT[d.puid]={model:d,marker:a.myMarkers[b].marker},a.myMarkers[b].model=d,a.myMarkers[b].infowindow&&(a.myMarkers[b].infowindow.close(),a.myMarkers[b].infowindow.setContent(a.myMarkers[b].marker.tpl2[0])),a.myMarkers[b].marker.model=d,"None"==a.myMarkers[b].marker.model.pois_type?a.myMarkers[b].marker.setIcon(o()):a.myMarkers[b].marker.setIcon(q()),google.maps.event.clearListeners(a.myMarkers[b].marker,"click");var g=a.myMarkers[b].infowindow;google.maps.event.addListener(a.myMarkers[b].marker,"click",function(){if(a.edgeMode)if(a.connectPois.prev){if(a.connectPois.prev==this)return a.connectPois.prev=void 0,void("None"===this.model.pois_type?this.setIcon(o()):this.setIcon(q()));"None"===a.connectPois.prev.model.pois_type?a.connectPois.prev.setIcon(o()):a.connectPois.prev.setIcon(q());var b=new google.maps.Polyline({path:[this.position,a.connectPois.prev.position],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:.5,strokeWeight:4});b.setMap(c.gmap);var d=a.connectPois.prev.model,e=this.model;if(!(d&&e&&d.puid&&e.puid&&d.buid&&e.buid&&!LPUtils.isNullOrUndefined(d.floor_number)&&!LPUtils.isNullOrUndefined(e.floor_number)))return void j("One or both of the POIs attempted to be connected seem to be be malformed. Please refresh.");var f={username:a.creds.username,password:a.creds.password,owner_id:a.owner_id,pois_a:d.puid,floor_a:d.floor_number,buid_a:d.buid,buid:d.buid,pois_b:e.puid,floor_b:e.floor_number,buid_b:e.buid,is_published:"true",edge_type:"hallway"};b.model=f;var h=a.anyAPI.addConnection(f);h.then(function(c){var d=c.data,e=d.cuid;b.model.cuid=e;var f=b.model;f.polyLine=b,a.myConnectionsHashT[e]=f,b.setOptions({strokeColor:"#0000FF",strokeOpacity:.5}),google.maps.event.addListener(b,"click",function(){a.$apply(s(this))})},function(a){a.data;j("Something went wrong while attempting to connect the two POIs."),b.setMap(null)}),a.connectPois.prev=void 0}else a.connectPois.prev=this,"None"===this.model.pois_type?this.setIcon(n()):this.setIcon(p());else{g.setContent(this.tpl2[0]),g.open(c.gmap,this);var i=this;a.$apply(function(){i.model&&i.model.puid&&(a.anyService.selectedPoi=i.model)})}}),google.maps.event.addListener(a.myMarkers[b].marker,"dragend",function(b){this.model&&this.model.puid&&a.updatePoiPosition(this)})},function(a){a.data;j("Something went wrong while adding the new POI.")})}}},a.deletePoi=function(b){var c=a.myPoisHashT[b];if(!c||!c.model||!c.model.puid){if(!(a.myPoisHashT&&a.myMarkers&&a.myMarkers[b]&&a.myMarkers[b].model&&a.myPoisHashT[a.myMarkers[b].model.puid]))return void j("No valid POI selected to be deleted.");if(c=a.myPoisHashT[a.myMarkers[b].model.puid],!c||!c.model||!c.model.puid)return void j("No valid POI selected to be deleted.")}var d,e=a.myConnectionsHashT;for(var f in e)if(e.hasOwnProperty(f)&&(d=e[f],d.pois_a==c.model.puid||d.pois_b==c.model.puid))return void j("Please delete all the connections attached to this POI first.");var g=c.model;g.username=a.creds.username,g.password=a.creds.password,g.owner_id=a.owner_id;var h=g.puid;g.is_building_entrance===!0||"true"===g.is_building_entrance?g.is_building_entrance="true":g.is_building_entrance="false";var i=a.anyAPI.deletePois(g);i.then(function(b){b.data;"true"===g.is_building_entrance?g.is_building_entrance=!0:g.is_building_entrance=!1;for(var c=a.myPois,d=c.length,e=0;d>e;e++)if(c[e].puid==h){c.splice(e,1),a.myPoisHashT[h]&&a.myPoisHashT[h].marker&&a.myPoisHashT[h].marker.setMap(null),delete a.myPoisHashT[h];break}k("Successfully deleted POI.")},function(b){for(var c=(b.data,a.myPois),d=c.length,e=0;d>e;e++)if(c[e].puid==h){c.splice(e,1),a.myPoisHashT[h]&&a.myPoisHashT[h].marker&&a.myPoisHashT[h].marker.setMap(null),delete a.myPoisHashT[h];break}j("Something went wrong while deleting POI.")})},a.updatePoi=function(b){var c=a.myPoisHashT[b];if(!c||!c.model||!c.model.puid){if(!(a.myPoisHashT&&a.myMarkers&&a.myMarkers[b]&&a.myMarkers[b].model&&a.myPoisHashT[a.myMarkers[b].model.puid]))return void j("No valid POI selected to be updated.");if(c=a.myPoisHashT[a.myMarkers[b].model.puid],!c||!c.model||!c.model.puid)return void j("No valid POI selected to be updated.")}var d=c.model;d.username=a.creds.username,d.password=a.creds.password,d.owner_id=a.owner_id;var e=c.marker;if(e){var f=e.position;f&&f.lat()&&f.lng()&&(d.coordinates_lat=String(f.lat()),d.coordinates_lon=String(f.lng()))}d.is_building_entrance?d.is_building_entrance="true":d.is_building_entrance="false";var g=a.anyAPI.updatePois(d);g.then(function(b){b.data;e&&e.infowindow.setMap(null),"true"==d.is_building_entrance?d.is_building_entrance=!0:d.is_building_entrance=!1;for(var c in a.myConnectionsHashT)if(a.myConnectionsHashT.hasOwnProperty(c)&&(a.myConnectionsHashT[c].pois_a==d.puid||a.myConnectionsHashT[c].pois_b==d.puid)){var f=a.myConnectionsHashT[c].pois_a,g=a.myConnectionsHashT[c].pois_b,h=[new google.maps.LatLng(a.myPoisHashT[f].model.coordinates_lat,a.myPoisHashT[f].model.coordinates_lon),new google.maps.LatLng(a.myPoisHashT[g].model.coordinates_lat,a.myPoisHashT[g].model.coordinates_lon)];a.myConnectionsHashT[c].polyLine.setPath(h)}},function(a){a.data;j("Something went wrong while updating POI. Please refresh and try again.")})},a.updatePoiPosition=function(b){var c;b&&b.model&&(c=b.model),c.username=a.creds.username,c.password=a.creds.password,c.owner_id=a.owner_id;var d=b.position;d&&d.lat()&&d.lng()&&(c.coordinates_lat=String(d.lat()),c.coordinates_lon=String(d.lng())),c.is_building_entrance?c.is_building_entrance="true":c.is_building_entrance="false";var e=a.anyAPI.updatePois(c);e.then(function(d){d.data;"true"==c.is_building_entrance||c.is_building_entrance===!0?c.is_building_entrance=!0:c.is_building_entrance=!1;for(var e in a.myConnectionsHashT)if(a.myConnectionsHashT.hasOwnProperty(e)&&(a.myConnectionsHashT[e].pois_a==b.model.puid||a.myConnectionsHashT[e].pois_b==b.model.puid)){var f=a.myConnectionsHashT[e].pois_a,g=a.myConnectionsHashT[e].pois_b,h=[new google.maps.LatLng(a.myPoisHashT[f].model.coordinates_lat,a.myPoisHashT[f].model.coordinates_lon),new google.maps.LatLng(a.myPoisHashT[g].model.coordinates_lat,a.myPoisHashT[g].model.coordinates_lon)];a.myConnectionsHashT[e].polyLine.setPath(h)}},function(a){a.data;j("Something went wrong while moving POI.")})},a.removeMarker=function(b){a.myMarkers[b]?(a.myMarkers[b].marker.setMap(null),delete a.myMarkers[b]):j("It seems that the marker to be deleted does not exist.")},a.placeMarker=function(e,f,g,h){var i=new google.maps.Marker({position:e,map:c.gmap,icon:new google.maps.MarkerImage(f,null,null,null,g),draggable:!0});if(null===d.getBuildingId()||void 0===d.getBuildingId())return void j("It seems there is no building selected. Please refresh.");var k=new google.maps.InfoWindow({content:"-",maxWidth:500});a.$apply(function(){i.myId=a.myMarkerId,a.myMarkers[i.myId]={},a.myMarkers[i.myId].model={buid:d.getBuildingId(),floor_number:d.getFloorNumber(),floor_name:d.getFloorName(),is_door:"false",is_building_entrance:"false",is_published:"true",description:"connector"===h?"Connector":"",name:"connector"===h?"Connector":"",pois_type:"connector"===h?"None":"",url:"-",image:"url_to_pois_image"},a.myMarkers[i.myId].marker=i,a.myMarkerId++;
});var m='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+i.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+i.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+i.myId+')" tabindex="3"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+i.myId+')" tabindex="6"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div></form></div>',n='<div class="infowindow-scroll-fix" ng-keydown="onInfoWindowKeyDown($event)"><form name="poiForm"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.name" id="poi-name" type="text" class="form-control" placeholder="poi name" tabindex="1" autofocus/></fieldset><fieldset class="form-group"><textarea ng-model="myMarkers['+i.myId+'].model.description" id="poi-description" type="text" class="form-control" placeholder="poi description" tabindex="5"></textarea></fieldset><fieldset class="form-group"><select ng-model="myMarkers['+i.myId+'].model.pois_type" class="form-control" ng-options="type for type in poisTypes" title="POI Types" tabindex="2"><option value="">Select POI Type</option></select></fieldset class="form-group"><fieldset class="form-group"><input ng-model="myMarkers['+i.myId+'].model.is_building_entrance" id="poi-entrance" type="checkbox" tabindex="4"><span> is building entrance?</span></fieldset><div style="text-align: center;"><fieldset class="form-group" style="display: inline-block; width: 75%;"><button type="submit" class="btn btn-success add-any-button" ng-click="updatePoi('+i.myId+')" tabindex="3"><span class="glyphicon glyphicon-pencil"></span> Update</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+i.myId+')" tabindex="6"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div></form></div>',o='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group" style="display: inline-block; width: 73%;"><button type="submit" class="btn btn-success add-any-button" ng-click="addPoi('+i.myId+')"><span class="glyphicon glyphicon-plus"></span> Add</button></fieldset><fieldset class="form-group" style="display: inline-block;width: 23%;"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deleteTempPoi('+i.myId+')"><span class="glyphicon glyphicon-remove"></span></button></fieldset></div>',p='<div class="infowindow-scroll-fix" style="text-align: center; width:170px"><div style="margin-bottom: 5px">POI Connector</div><fieldset class="form-group"><button type="submit" class="btn btn-danger add-any-button" style="margin-left:2px" ng-click="deletePoi('+i.myId+')"><span class="glyphicon glyphicon-remove"></span> Remove</button></fieldset></div>';if("poi"==h){var q=b(m)(a);i.tpl2=b(n)(a),k.setContent(q[0]),k.open(c.gmap,i)}else if("connector"==h){var r=b(o)(a);i.tpl2=b(p)(a),k.setContent(r[0]),a.addPoi(i.myId)}a.$apply(a.myMarkers[i.myId].infowindow=k),google.maps.event.addListener(i,"click",function(){a.edgeMode&&a.$apply(l("Only submitted objects can be connected together.")),k.open(c.gmap,i)})},a.deleteTempPoi=function(b){return a.myMarkers&&a.myMarkers[b].marker?void a.myMarkers[b].marker.setMap(null):void j("No valid POI marker to delete found.")},a.toggleEdgeMode=function(){a.edgeMode=!a.edgeMode,a.edgeMode||(a.connectPois.prev=void 0)},$("#draggable-poi").draggable({helper:"clone",stop:function(b){var c=new google.maps.Point(b.pageX,b.pageY),d=t.getProjection().fromContainerPixelToLatLng(c);return m(d)?void a.placeMarker(d,h,new google.maps.Size(21,32),"poi"):void a.$apply(l("The marker was placed too far away from the selected building."))}}),$("#draggable-connector").draggable({helper:"clone",stop:function(b){var c=new google.maps.Point(b.pageX,b.pageY),d=t.getProjection().fromContainerPixelToLatLng(c);return m(d)?void a.placeMarker(d,f,new google.maps.Size(21,21),"connector"):void a.$apply(l("The marker was placed too far away from the selected building."))}})}]);