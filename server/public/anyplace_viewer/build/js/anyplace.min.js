function CanvasOverlay(a,b){for(this.top=0,this.left=0,this.width=a.width,this.height=a.height;window&&(this.width>window.innerWidth||this.height>window.innerHeight);)this.width/=2,this.height/=2;this.image_=a,this.map_=b,this.div_=null,this.canvas=null,this.ctx=null,this.angle=0,this.scale=1,this.latlng=b.getCenter(),this.new_left=0,this.new_top=0,this.setMap(b)}function deg2rad(a){return a*Math.PI/180}function rad2deg(a){return a/Math.PI*180}function getRotationDegrees(a){var b=a.css("-webkit-transform")||a.css("-moz-transform")||a.css("-ms-transform")||a.css("-o-transform")||a.css("transform");if("none"!==b)var c=b.split("(")[1].split(")")[0].split(","),d=c[0],e=c[1],f=(c[2],c[3],Math.sqrt(d*d+e*e),Math.round(Math.atan2(e,d)*(180/Math.PI)));else var f=0;return f}function hexToBase64(a){return btoa(String.fromCharCode.apply(null,a.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")))}function base64_encode(a){var b,c,d,e,f,g,h,i,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=0,l=0,m="",n=[];if(!a)return a;do b=a.charCodeAt(k++),c=a.charCodeAt(k++),d=a.charCodeAt(k++),i=b<<16|c<<8|d,e=i>>18&63,f=i>>12&63,g=i>>6&63,h=63&i,n[l++]=j.charAt(e)+j.charAt(f)+j.charAt(g)+j.charAt(h);while(k<a.length);m=n.join("");var o=a.length%3;return(o?m.slice(0,o-3):m)+"===".slice(o||3)}function USGSOverlay(a,b,c){this.bounds_=a,this.image_=b,this.image64=b,this.map_=c,this.div_=null,this.setMap(c)}var app=angular.module("anyViewer",["ngRoute","ui.bootstrap","ui.select","ngSanitize","angular-loading-bar"]);app.service("GMapService",function(){this.gmap={},this.directionsDisplay=void 0,this.directionsService=void 0;var a=this,b={center:{lat:30,lng:0},minZoom:2,zoom:2,panControl:!1,zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.LEFT_CENTER},rotateControl:!0,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},scaleControl:!0,streetViewControl:!1,overviewMapControl:!0};a.gmap=new google.maps.Map(document.getElementById("map-canvas"),b);var c=new google.maps.DirectionsService,d=new google.maps.DirectionsRenderer;a.calcRoute=function(b,e,f){if(!b||!e)return void console.log("Invalid start or end point.");var g={origin:b,destination:e,travelMode:google.maps.TravelMode.DRIVING};c.route(g,function(b,c){if(c==google.maps.DirectionsStatus.OK)if(d.setMap(a.gmap),d.setDirections(b),b&&b.routes&&b.routes.length&&b.routes[0].overview_path&&b.routes[0].overview_path.length){var e=b.routes[0].overview_path.length;f(b.routes[0].overview_path[e-1])}else f(void 0);else f(void 0)})},a.clearRoute=function(){d&&d.setMap(null)},a.isRouteShown=function(){return d&&d.getMap()}}),app.factory("AnyplaceService",["$rootScope","$q",function(a,b){var c={};return c.selectedBuilding=void 0,c.selectedFloor=void 0,c.selectedPoi=void 0,c.availableFloors={},c.jsonReq={username:"username",password:"password"},c.alerts=[],c.getBuilding=function(){return this.selectedBuilding},c.getBuildingId=function(){return this.selectedBuilding?this.selectedBuilding.buid:void 0},c.getBuildingName=function(){return this.selectedBuilding?this.selectedBuilding.name:"N/A"},c.getFloor=function(){return this.selectedFloor},c.getFloorNumber=function(){return this.selectedFloor?String(this.selectedFloor.floor_number):"N/A"},c.setBuilding=function(a){this.selectedBuilding=a},c.setFloor=function(a){this.selectedFloor=a},c.setSelectedFloorByNum=function(a){this.selectedFloor=c.availableFloors[a]},c.addAlert=function(a,d){this.alerts[0]={msg:d,type:a};var e=b(function(a,b){setTimeout(function(){a()},3500)});e.then(function(){c.alerts.splice(0,1)},function(){})},c.closeAlert=function(a){this.alerts.splice(a,1)},c.getBuildingViewerUrl=function(){return this.selectedBuilding&&this.selectedBuilding.buid?"http://anyplace.cs.ucy.ac.cy/viewer/?buid="+this.selectedBuilding.buid:"N/A"},c.getViewerUrl=function(){var a="http://anyplace.cs.ucy.ac.cy/viewer";return this.selectedBuilding&&this.selectedBuilding.buid?(a+="?buid="+this.selectedBuilding.buid,this.selectedFloor&&this.selectedFloor.floor_number?(a+="&floor="+this.selectedFloor.floor_number,this.selectedPoi&&this.selectedPoi.puid?a+="&selected="+this.selectedPoi.puid:a):a):a},c.clearAllData=function(){c.selectedPoi=void 0,c.selectedFloor=void 0,c.selectedBuilding=void 0},c}]),app.factory("Alerter",function(){var a={};return a.AlertCtrl="-",a}),app.factory("formDataObject",function(){return function(a,b){var c=new FormData;angular.forEach(a,function(a,b){c.append(b,a)});var d=b();return delete d["Content-Type"],c}}),app.config(["$locationProvider",function(a){a.html5Mode({enabled:!0,requireBase:!1})}]),app.config(["$routeProvider",function(a){a.when("/#/b/:alias",{templateUrl:"index.html",controller:"ControlBarController",caseInsensitiveMatch:!0}).otherwise({redirectTo:"/",caseInsensitiveMatch:!0})}]),app.config(["cfpLoadingBarProvider",function(a){a.includeSpinner=!1}]),app.filter("propsFilter",function(){return function(a,b){var c=[];return angular.isArray(a)?a.forEach(function(a){for(var d=!1,e=Object.keys(b),f=0;f<e.length;f++){var g=e[f],h=b[g].toLowerCase();if(-1!==a[g].toString().toLowerCase().indexOf(h)){d=!0;break}}d&&c.push(a)}):c=a,c}});var AnyplaceAPI={};AnyplaceAPI.FULL_SERVER="http://anyplace.rayzit.com/anyplace",AnyplaceAPI.Mapping={},AnyplaceAPI.Navigation={},AnyplaceAPI.Other={},AnyplaceAPI.Other.GOOGLE_URL_SHORTNER_URL="https://www.googleapis.com/urlshortener/v1/url?key=AIzaSyDLSYNnIC93KfPnMYRL-7xI7yXjOhgulk8",AnyplaceAPI.Mapping.BUILDING_ONE="/mapping/building/get",AnyplaceAPI.Mapping.BUILDING_ONE_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_ONE,AnyplaceAPI.Mapping.BUILDING_ALL="/mapping/building/all",AnyplaceAPI.Mapping.BUILDING_ALL_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.BUILDING_ALL,AnyplaceAPI.Mapping.FLOOR_ALL="/mapping/floor/all",AnyplaceAPI.Mapping.FLOOR_ALL_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_ALL,AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD="/floorplans64/",AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD,AnyplaceAPI.Mapping.POIS_ALL_FLOOR="/mapping/pois/all_floor",AnyplaceAPI.Mapping.POIS_ALL_FLOOR_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_ALL_FLOOR,AnyplaceAPI.Mapping.POIS_ALL_BUILDING="/mapping/pois/all_building",AnyplaceAPI.Mapping.POIS_ALL_BUILDING_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.POIS_ALL_BUILDING,AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR="/mapping/connection/all_floor",AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR_URL=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR,AnyplaceAPI.Navigation.POIS_ROUTE="/navigation/route",AnyplaceAPI.Navigation.POIS_ROUTE=AnyplaceAPI.FULL_SERVER+AnyplaceAPI.Navigation.POIS_ROUTE,app.factory("AnyplaceAPIService",["$http","$q","formDataObject",function(a,b,c){a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"];var d={};return d.allBuildings=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_ALL_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.getOneBuilding=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.BUILDING_ONE_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.allBuildingFloors=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_ALL_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.downloadFloorPlan=function(b,c,d){return a({method:"POST",url:AnyplaceAPI.Mapping.FLOOR_PLAN_DOWNLOAD_URL+c+"/"+d,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrievePoisByBuildingFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_ALL_FLOOR_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrievePoisByBuilding=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.POIS_ALL_BUILDING_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrieveConnectionsByBuildingFloor=function(b){return a({method:"POST",url:AnyplaceAPI.Mapping.CONNECTION_ALL_FLOOR_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.retrieveRouteFromPoiToPoi=function(b){return a({method:"POST",url:AnyplaceAPI.Navigation.POIS_ROUTE,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d.googleUrlShortener=function(b){return a({method:"POST",url:AnyplaceAPI.Other.GOOGLE_URL_SHORTNER_URL,data:b}).success(function(a,b){return a}).error(function(a,b){return a})},d}]),CanvasOverlay.prototype=new google.maps.OverlayView,CanvasOverlay.prototype.onAdd=function(){var a=document.createElement("div");a.id="canvas_editor",a.style.border="none",a.style.borderWidth="0px",a.style.position="relative",a.style.top=this.top,a.style.left=this.left;var b;if(null!=(b=this.getProjection())){var c=b.fromLatLngToDivPixel(this.latlng);a.style.top=c.y-this.height/2+"px",a.style.left=c.x-this.width/2+"px"}var d=this;jQuery(a).draggable({stop:function(a,c){if(null!=b){var e=$(this).position().left,f=$(this).position().top;d.latlng=b.fromDivPixelToLatLng(new google.maps.Point(e,f),!0)}}}),jQuery(a).resizable({aspectRatio:this.image_.width/this.image_.height,ghost:!0,handles:"sw, se, nw, ne",helper:"resizable-helper",stop:function(a,b){d.ctx.clearRect(0,0,d.ctx.canvas.width,d.ctx.canvas.height),d.width=b.size.width,d.height=b.size.height,d.setCanvasSize(),d.ctx.save(),d.ctx.translate(d.ctx.canvas.width/2,d.ctx.canvas.height/2),d.ctx.drawImage(d.image_,-(d.width/2),-(d.height/2),d.width,d.height),d.ctx.restore()}}),jQuery(a).rotatable({stop:function(a,b){}});var e=document.createElement("canvas");e.id="canvas",a.appendChild(e),this.div_=a,this.canvas=e,this.ctx=e.getContext("2d"),this.initImage();var f=this.getPanes();return f.overlayImage.appendChild(this.div_),this},CanvasOverlay.prototype.draw=function(){this.div_;null==this.canvas&&alert("error creating the canvas")},CanvasOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_)},CanvasOverlay.prototype.hide=function(){this.div_&&(this.div_.style.visibility="hidden")},CanvasOverlay.prototype.show=function(){this.div_&&(this.div_.style.visibility="visible")},CanvasOverlay.prototype.toggle=function(){this.div_&&("hidden"==this.div_.style.visibility?this.show():this.hide())},CanvasOverlay.prototype.toggleDOM=function(){this.setMap(this.getMap()?null:this.map_)},CanvasOverlay.prototype.getCanvas=function(){return this.canvas},CanvasOverlay.prototype.getContext2d=function(){return this.ctx},CanvasOverlay.prototype.setCanvasSize=function(){this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.div_.style.width=this.width+"px",this.div_.style.height=this.height+"px"},CanvasOverlay.prototype.initImage=function(){this.setCanvasSize(),this.ctx.save(),this.ctx.translate(this.ctx.canvas.width/2,this.ctx.canvas.height/2),this.ctx.rotate(this.angle),this.ctx.drawImage(this.image_,-(this.width/2),-(this.height/2),this.width,this.height),this.ctx.restore()},CanvasOverlay.prototype.drawBoundingCanvas=function(){var a=getRotationDegrees($("#canvas_editor")),b=deg2rad(a);console.log("deg["+a+"] rad["+b+"]"),$("#canvas_editor").css({"-moz-transform":"rotate(0deg)","-webkit-transform":"rotate(0deg)","-ms-transform":"rotate(0deg)","-o-transform":"rotate(0deg)",transform:"rotate(0deg)"});var c=getPositionData($("#canvas_editor")),d=c.left,e=c.top,f=d+this.width/2,g=e+this.height/2,h=f+(d-f)*Math.cos(b)+(e-g)*Math.sin(b),i=g-(d-f)*Math.sin(b)+(e-g)*Math.cos(b),j=f+(d+this.width-f)*Math.cos(b)+(e-g)*Math.sin(b),k=g-(d+this.width-f)*Math.sin(b)+(e-g)*Math.cos(b),l=f+(d-f)*Math.cos(b)+(e+this.height-g)*Math.sin(b),m=g-(d-f)*Math.sin(b)+(e+this.height-g)*Math.cos(b),n=f+(d+this.width-f)*Math.cos(b)+(e+this.height-g)*Math.sin(b),o=g-(d+this.width-f)*Math.sin(b)+(e+this.height-g)*Math.cos(b),p=Math.max(h,j,l,n),q=Math.max(i,k,m,o),r=Math.min(h,j,l,n),s=Math.min(i,k,m,o),t=s,u=r,v=p-r,w=q-s;console.log("w["+v+"] h["+w+"]"),$("#canvas_editor").css({top:t+"px",left:u+"px"}),this.ctx.canvas.width=v,this.ctx.canvas.height=w,this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.translate(f-u,g-t),this.ctx.rotate(b),this.ctx.drawImage(this.image_,-(this.width/2),-(this.height/2),this.width,this.height),this.ctx.restore(),this.top=t,this.left=u;var x;null!=(x=this.getProjection())&&(this.bottom_left_coords=x.fromContainerPixelToLatLng(new google.maps.Point(this.left,this.top+w),!0),this.top_right_coords=x.fromContainerPixelToLatLng(new google.maps.Point(this.left+v,this.top),!0))};var getPositionData=function(a){return $.extend({width:a.outerWidth(!1),height:a.outerHeight(!1)},a.offset())},LPUtils={};LPUtils.isNullOrUndefined=function(a){return"undefined"==typeof a||null===a},LPUtils.isStringEmptyNullUndefined=function(a){return!a||0===a.length},LPUtils.isStringBlankNullUndefined=function(a){return!a||/^\s*$/.test(a)},LPUtils.alert=function(a){var b=document.getElementById("notification_panel");b.innerHTML='<alert type="error" close="LPUtils.closeAlert()">'+a+"</alert>"},LPUtils.closeAlert=function(){var a=document.getElementById("notification_panel");a.getEl.innerHTML=""},LPUtils.success=function(a){var b=document.getElementById("notification_panel");b.innerHTML='<alert type="success">'+a+"</alert>"},LPUtils.Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=LPUtils.Base64._utf8_encode(a);j<a.length;)b=a.charCodeAt(j++),c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=b>>2,f=(3&b)<<4|c>>4,g=(15&c)<<2|d>>6,h=63&d,isNaN(c)?g=h=64:isNaN(d)&&(h=64),i=i+this._keyStr.charAt(e)+this._keyStr.charAt(f)+this._keyStr.charAt(g)+this._keyStr.charAt(h);return i},decode:function(a){var b,c,d,e,f,g,h,i="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)e=this._keyStr.indexOf(a.charAt(j++)),f=this._keyStr.indexOf(a.charAt(j++)),g=this._keyStr.indexOf(a.charAt(j++)),h=this._keyStr.indexOf(a.charAt(j++)),b=e<<2|f>>4,c=(15&f)<<4|g>>2,d=(3&g)<<6|h,i+=String.fromCharCode(b),64!=g&&(i+=String.fromCharCode(c)),64!=h&&(i+=String.fromCharCode(d));return i=LPUtils.Base64._utf8_decode(i)},_utf8_encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b},_utf8_decode:function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=String.fromCharCode(d),c++):d>191&&224>d?(c2=a.charCodeAt(c+1),b+=String.fromCharCode((31&d)<<6|63&c2),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=String.fromCharCode((15&d)<<12|(63&c2)<<6|63&c3),c+=3);return b}},LPUtils.Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=a.length/4*3,c=new ArrayBuffer(b);return this.decode(a,c),c},decode:function(a,b){var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-2)),e=a.length/4*3;64==c&&e--,64==d&&e--;var f,g,h,i,j,k,l,m,n=0,o=0;for(f=new Uint8Array(b?b:e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),n=0;e>n;n+=3)j=this._keyStr.indexOf(a.charAt(o++)),k=this._keyStr.indexOf(a.charAt(o++)),l=this._keyStr.indexOf(a.charAt(o++)),m=this._keyStr.indexOf(a.charAt(o++)),g=j<<2|k>>4,h=(15&k)<<4|l>>2,i=(3&l)<<6|m,f[n]=g,64!=l&&(f[n+1]=h),64!=m&&(f[n+2]=i);return f}},USGSOverlay.prototype=new google.maps.OverlayView,USGSOverlay.prototype.onAdd=function(){var a=document.createElement("div");a.id="ground_overlay",a.style.borderStyle="none",a.style.borderWidth="0px",a.style.position="absolute";var b=document.createElement("img");b.src=this.image64,b.style.width="100%",b.style.height="100%",b.style.position="absolute",a.appendChild(b),this.div_=a;var c=this.getPanes();c.overlayLayer.appendChild(a)},USGSOverlay.prototype.draw=function(){var a=this.getProjection(),b=a.fromLatLngToDivPixel(this.bounds_.getSouthWest()),c=a.fromLatLngToDivPixel(this.bounds_.getNorthEast()),d=this.div_;d.style.left=b.x+"px",d.style.top=c.y+"px",d.style.width=c.x-b.x+"px",d.style.height=b.y-c.y+"px"},USGSOverlay.prototype.onRemove=function(){this.div_.parentNode.removeChild(this.div_),this.div_=null},app.controller("AlertController",["$rootScope","$scope","AnyplaceService",function(a,b,c){b.anyService=c,b.alerts=c.alerts,b.closeable=!0}]),app.controller("BuildingController",["$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(a,b,c,d,e){a.gmapService=c,a.anyService=d,a.anyAPI=e,a.myBuildings=[],a.myBuildingsHashT={};var f=new MarkerClusterer(a.gmapService.gmap),g=function(b){for(var c in a.myBuildingsHashT)a.myBuildingsHashT.hasOwnProperty(c)&&a.myBuildingsHashT[c].marker.setVisible(b)};a.$watch("anyService.selectedBuilding",function(b,c){if(b&&b.coordinates_lat&&b.coordinates_lon){if(!b.buid)return void i("Some information is missing from the building and it could not be loaded.");c&&c.buid&&a.myBuildingsHashT[c.buid].marker.setVisible(!0),a.myBuildingsHashT[b.buid].marker.setVisible(!1),a.gmapService.gmap.panTo(h(b)),a.gmapService.gmap.setZoom(20);try{"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastBuilding",b.buid)}catch(d){}}else g(!0)});var h=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0};a.fetchBuilding=function(b){var d={buid:b},e=a.anyAPI.getOneBuilding(d);e.then(function(b){var d=b.data,e=d.building;a.myBuildings.push(e);var g=new google.maps.Size(55,80);a.isFirefox&&(g=new google.maps.Size(110,160));var i=new google.maps.Marker({position:h(e),icon:{url:"build/images/building-icon.png",size:g,scaledSize:new google.maps.Size(55,80)},draggable:!1});f.addMarker(i);var j='<div class="infowindow-scroll-fix"><h5 style="margin: 0">Building:</h5><span>'+e.name+'</span><h5 style="margin: 8px 0 0 0">Description:</h5><span>'+e.description+"</span></div>";i.infoContent=j,i.building=e,a.myBuildingsHashT[e.buid]={marker:i,model:e},google.maps.event.addListener(i,"click",function(){infowindow.setContent(this.infoContent),infowindow.open(c.gmap,this),setTimeout(function(){infowindow.setMap(null)},2e3);var b=this;a.$apply(function(){a.anyService.selectedBuilding=b.building})}),a.anyService.selectedBuilding=e},function(a){i("No matching building found")})},a.fetchAllBuildings=function(){var b={};b.username=a.creds.username,b.password=a.creds.password;var d=a.anyAPI.allBuildings(b);d.then(function(b){var d=b.data;a.myBuildings=d.buildings;var e=new google.maps.InfoWindow({content:"-",maxWidth:500}),g=-1,i=void 0;try{"undefined"!=typeof Storage&&localStorage&&localStorage.getItem("lastBuilding")&&(i=localStorage.getItem("lastBuilding"))}catch(j){}for(var k=-1,l=0;l<a.myBuildings.length;l++){var m=a.myBuildings[l];i&&i===m.buid&&(g=l),"true"===m.is_published||1==m.is_published?m.is_published=!0:m.is_published=!1,a.urlBuid&&a.urlBuid==m.buid&&(k=l);var n=new google.maps.Size(55,80);a.isFirefox&&(n=new google.maps.Size(110,160));var o=new google.maps.Marker({position:h(m),icon:{url:"build/images/building-icon.png",size:n,scaledSize:new google.maps.Size(55,80)},draggable:!1});f.addMarker(o);var p='<div class="infowindow-scroll-fix"><h5 style="margin: 0">Building:</h5><span>'+m.name+'</span><h5 style="margin: 8px 0 0 0">Description:</h5><span>'+m.description+"</span></div>";o.infoContent=p,o.building=m,a.myBuildingsHashT[m.buid]={marker:o,model:m},google.maps.event.addListener(o,"click",function(){e.setContent(this.infoContent),e.open(c.gmap,this),setTimeout(function(){e.setMap(null)},2e3);var b=this;a.$apply(function(){a.anyService.selectedBuilding=b.building})})}k>-1?a.anyService.selectedBuilding=a.myBuildings[k]:a.urlBuid?a.fetchBuilding(a.urlBuid):g>=0&&(a.anyService.selectedBuilding=a.myBuildings[g])},function(a){a.data;i("Something went wrong while fetching buildings.")})},a.fetchAllBuildings();var i=function(b){a.anyService.addAlert("danger",b)},j=function(a,b,c,d){return Math.sqrt(Math.pow(c-a,2)+Math.pow(d-b,2))};a.orderByName=function(a){return a.name},a.orderByDistCentre=function(b){if(a.anyService.selectedBuilding)return b.name;var c=a.gmapService.gmap.getCenter();return j(parseFloat(b.coordinates_lat),parseFloat(b.coordinates_lon),c.lat(),c.lng())}}]),app.controller("ControlBarController",["$scope","$rootScope","$routeParams","$location","$compile","GMapService","AnyplaceService",function(a,b,c,d,e,f,g){a.anyService=g,a.gmapService=f,a.isFirefox=navigator.userAgent.search("Firefox")>-1,a.creds={username:"username",password:"password"},a.tab=1;var h=function(b){a.anyService.addAlert("danger",b)},i=d.search();i&&(a.urlBuid=i.buid,a.urlFloor=i.floor,a.urlPuid=i.selected),a.setTab=function(b){a.tab=b},a.isTabSet=function(b){return a.tab===b};var j=$("#my-loc-control");j.replaceWith(e(j.html())(a));var k=void 0;a.userPosition=void 0;var l=-1,m=!1;a.isUserLocVisible=!1,a.getIsUserLocVisible=function(){return a.isUserLocVisible},a.panToUserLocation=function(){a.userPosition&&(f.gmap.panTo(a.userPosition),f.gmap.setZoom(20))},a.isMyLocMarkerShown=function(){return k&&k.getMap()},a.displayMyLocMarker=function(b){if(k&&k.getMap())return void k.setPosition(b);var c=new google.maps.Size(20,20);a.isFirefox&&(c=new google.maps.Size(48,48)),k=new google.maps.Marker({position:b,map:f.gmap,draggable:!1,icon:{url:"build/images/location-radius-centre.png",origin:new google.maps.Point(0,0),anchor:new google.maps.Point(10,10),size:c,scaledSize:new google.maps.Size(20,20)}})},a.showUserLocation=function(){return a.getIsUserLocVisible()?(a.hideUserLocation(),void(navigator.geolocation&&navigator.geolocation.clearWatch(l))):void(navigator.geolocation?l=navigator.geolocation.watchPosition(function(b){var c={lat:b.coords.latitude,lng:b.coords.longitude};a.userPosition=c,a.displayMyLocMarker(c);var d=new google.maps.InfoWindow({content:"Your current location.",maxWidth:500});google.maps.event.addListener(k,"click",function(){var b=this;a.$apply(function(){d.open(f.gmap,b)})}),a.isUserLocVisible||a.$apply(function(){a.isUserLocVisible=!0}),m||(f.gmap.panTo(c),f.gmap.setZoom(19),m=!0)},function(b){a.$apply(function(){h(1==b.code?"Permission denied. Anyplace was not able to retrieve your Geolocation.":2==b.code?"Position unavailable. The network is down or the positioning satellites couldn't be contacted.":3==b.code?"Timeout. The request for retrieving your Geolocation was timed out.":"There was an error while retrieving your Geolocation. Please try again.")})}):h("The Geolocation feature is not supported by this browser."))},a.hideUserLocation=function(){k&&k.setMap(null),a.isUserLocVisible=!1},a.showAndroidPrompt=function(){try{if("undefined"!=typeof Storage&&localStorage&&localStorage.getItem("androidPromptShown")){var a=$("#android_top_DIV_1");a&&a.remove()}}catch(b){}},a.hideAndroidBar=function(){var a=$("#android_top_DIV_1");a&&a.remove();try{"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("androidPromptShown",!0)}catch(b){}};var n=navigator.userAgent.toLowerCase(),o=n.indexOf("android")>-1&&!n.indexOf("windows")>-1,p=$("#android_top_DIV_1");p&&o&&p.css({display:"block"}),a.centerViewToSelectedItem=function(){var b={};if(a.anyService.selectedPoi){var c=a.anyService.selectedPoi;b={lat:parseFloat(c.coordinates_lat),lng:parseFloat(c.coordinates_lon)}}else{if(!a.anyService.selectedBuilding)return void h("No building is selected.");var d=a.anyService.selectedBuilding;b={lat:parseFloat(d.coordinates_lat),lng:parseFloat(d.coordinates_lon)}}a.gmapService.gmap.panTo(b),a.gmapService.gmap.setZoom(20)}}]),app.controller("DropDownCtrl",["$scope",function(a){a.items=[],a.status={isopen:!1},a.toggled=function(a){},a.toggleDropdown=function(b){b.preventDefault(),b.stopPropagation(),a.status.isopen=!a.status.isopen}}]),app.controller("FloorController",["$scope","$compile","AnyplaceService","GMapService","AnyplaceAPIService",function(a,b,c,d,e){a.anyService=c,a.anyAPI=e,a.xFloors=[],a.data={floor_plan_coords:{},floor_plan_base64_data:{},floor_plan_groundOverlay:null};a.$watch("anyService.selectedBuilding",function(b,c){b&&b.buid?a.fetchAllFloorsForBuilding(b):a.removeFloorPlanOverlay()}),a.$watch("anyService.selectedFloor",function(b,c){if(void 0!==b&&null!==b){a.fetchFloorPlanOverlay(b),d.gmap.panTo(f(a.anyService.selectedBuilding)),d.gmap.setZoom(20);try{"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastFloor",b.floor_number)}catch(e){}}}),a.removeFloorPlanOverlay=function(){a.data.floor_plan_groundOverlay&&a.data.floor_plan_groundOverlay.setMap(null)};var f=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0},g=function(b){a.anyService.addAlert("danger",b)};a.orderByFloorNo=function(a){return!a||LPUtils.isNullOrUndefined(a.floor_number)?0:parseInt(a.floor_number)},a.fetchAllFloorsForBuilding=function(b){var d=c.jsonReq;d.buid=b.buid;var f=e.allBuildingFloors(d);f.then(function(b){a.xFloors=b.data.floors,a.xFloors=a.xFloors.sort(function(a,b){return parseInt(a.floor_number)-parseInt(b.floor_number)}),a.anyService.availableFloors={};for(var c=0;c<a.xFloors.length;c++){var d=a.xFloors[c];a.anyService.availableFloors[d.floor_number]=d}if(a.urlFloor)for(var e=0;e<a.xFloors.length;e++)if(a.urlFloor==a.xFloors[e].floor_number)return void(a.anyService.selectedFloor=a.xFloors[e]);try{if("undefined"!=typeof Storage&&localStorage&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))&&!LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor")))for(var f=0;f<a.xFloors.length;f++)if(String(a.xFloors[f].floor_number)===String(localStorage.getItem("lastFloor")))return void(a.anyService.selectedFloor=a.xFloors[f])}catch(g){}for(var h=0;h<a.xFloors.length;h++)if("0"==a.xFloors[h].floor_number)return void(a.anyService.selectedFloor=a.xFloors[h]);a.xFloors[0]&&(a.anyService.selectedFloor=a.xFloors[0])},function(a){console.log(a.data.message),g("Something went wrong while fetching all floors")})},a.fetchFloorPlanOverlay=function(){var b=a.anyService.selectedFloor.floor_number,c=a.anyService.selectedBuilding.buid,f=e.downloadFloorPlan(this.anyService.jsonReq,c,b);f.then(function(e){if(c==a.anyService.selectedBuilding.buid&&b==a.anyService.selectedFloor.floor_number){a.data.floor_plan_file=null,a.data.floor_plan=null,null!=a.data.floor_plan_groundOverlay&&(a.data.floor_plan_groundOverlay.setMap(null),a.data.floor_plan_groundOverlay=null);var f=e.data,g=a.anyService.selectedFloor,h=new google.maps.LatLngBounds(new google.maps.LatLng(g.bottom_left_lat,g.bottom_left_lng),new google.maps.LatLng(g.top_right_lat,g.top_right_lng));a.data.floor_plan_groundOverlay=new USGSOverlay(h,"data:image/png;base64,"+f,d.gmap)}},function(a){})};var h=null;a.isCanvasOverlayActive=!1,a.setFloorPlan=function(){if(h){(null===c.getBuildingId()||void 0===c.getBuildingId())&&(console.log("building is undefined"),g("Something went wrong. It seems like there is no building selected"));var b={is_published:"true",buid:String(c.getBuildingId()),floor_name:String(a.newFloorNumber),description:String(a.newFloorNumber),floor_number:String(a.newFloorNumber)};a.myFloors[a.myFloorId]=b,a.myFloorId++,h.drawBoundingCanvas();var e=h.bottom_left_coords,f=h.top_right_coords;a.data.floor_plan_coords.bottom_left_lat=e.lat(),a.data.floor_plan_coords.bottom_left_lng=e.lng(),a.data.floor_plan_coords.top_right_lat=f.lat(),a.data.floor_plan_coords.top_right_lng=f.lng();var i=h.getCanvas().toDataURL("image/png");a.data.floor_plan_base64_data=i;var j=new google.maps.LatLngBounds(new google.maps.LatLng(e.lat(),e.lng()),new google.maps.LatLng(f.lat(),f.lng()));a.data.floor_plan_groundOverlay=new USGSOverlay(j,i,d.gmap),h.setMap(null),$("#input-floor-plan").prop("disabled",!1),a.isCanvasOverlayActive=!1,a.addFloorObject(b,a.anyService.selectedBuilding,a.data)}},a.removeFloorPlan=function(){a.data.floor_plan_file=null,a.data.floor_plan=null,h&&h.setMap(null);var b=$("#input-floor-plan");b.replaceWith(b=b.clone(!0)),b.prop("disabled",!1),a.isCanvasOverlayActive=!1},a.floorUp=function(){for(var b=0;b<a.xFloors.length;b++)if(a.xFloors[b].floor_number==a.anyService.selectedFloor.floor_number)return b+1<a.xFloors.length?void(a.anyService.selectedFloor=a.xFloors[b+1]):void 0;g("Floor not found.")},a.floorDown=function(){for(var b=0;b<a.xFloors.length;b++)if(a.xFloors[b].floor_number==a.anyService.selectedFloor.floor_number)return b-1>=0?void(a.anyService.selectedFloor=a.xFloors[b-1]):void 0;g("Floor not found.")};var i=$("#floor-controls");i.replaceWith(b(i.html())(a))}]),app.controller("PoiController",["$scope","$compile","GMapService","AnyplaceService","AnyplaceAPIService",function(a,b,c,d,e){var f=new google.maps.Size(62,93),g=new google.maps.Size(21,32),h=new google.maps.Size(31,48),i=17;a.anyService=d,a.anyAPI=e,a.gmapService=c,a.myPois=[],a.myPoisHashT={},a.myEntrances=[],a.showPoiDescription=!1,a.poiShareUrl={puid:void 0,url:"..."},a.poiRouteState={form:void 0},a.togglePoiDescription=function(){a.showPoiDescription=!a.showPoiDescription};var j=void 0,k={},l=void 0,m=void 0,n=!1,o=void 0;google.maps.event.addListener(a.gmapService.gmap,"zoom_changed",function(){var a=this.getZoom();i>=a?A():B()});var p=function(){if(a.anyService.selectedPoi){var b=a.anyService.selectedPoi;b.puid&&a.myPoisHashT[b.puid]&&a.myPoisHashT[b.puid].marker&&a.myPoisHashT[b.puid].marker.infowindow&&a.myPoisHashT[b.puid].marker.infowindow.setMap(null)}};google.maps.event.addListener(a.gmapService.gmap,"click",function(){p()}),a.$watch("anyService.selectedBuilding",function(b,c){b&&b.buid?(n=!1,a.removePoisOnMap(),a.myEntrances=[],a.myPoisHashT={},a.fetchAllPoisForBuilding(b),a.clearNavPolylines()):(a.anyService.selectedPoi=void 0,a.removePoisOnMap(),a.clearNavPolylines())}),a.$watch("anyService.selectedFloor",function(b,c){void 0!==b&&null!==b&&n?(b.floor_number&&a.showPoisOnlyForFloor(b.floor_number),x(b,c)):a.anyService.selectedPoi=void 0}),a.$watch("anyService.selectedPoi",function(b,d){if(b&&b.puid&&s(b)){if(a.poiShareUrl.puid=void 0,a.poiShareUrl.url="...",a.anyService.getFloorNumber()!=b.floor_number&&a.anyService.setSelectedFloorByNum(b.floor_number),c.gmap.panTo(s(b)),c.gmap.setZoom(20),b.puid&&a.myPoisHashT[b.puid]&&a.myPoisHashT[b.puid].marker){var e=a.myPoisHashT[b.puid].marker;e.setVisible(!0),e.setIcon(u(b)),e.infowindow&&(e.infowindow.setContent(e.tpl2),e.infowindow.open(c.gmap,e))}o&&o.puid&&a.myPoisHashT[o.puid]&&a.myPoisHashT[o.puid].marker&&(a.myPoisHashT[o.puid].marker.setIcon(v(o)),c.gmap.getZoom()<=i&&a.myPoisHashT[o.puid].marker.setVisible(!1));try{"undefined"!=typeof Storage&&localStorage&&localStorage.setItem("lastPoi",b.puid)}catch(f){}o=b}});var q=function(b){a.anyService.addAlert("danger",b)},r=function(b){a.anyService.addAlert("success",b)},s=function(a){return a&&a.coordinates_lat&&a.coordinates_lon?{lat:parseFloat(a.coordinates_lat),lng:parseFloat(a.coordinates_lon)}:void 0};a.orderByName=function(a){return a.name},a.orderByFloor=function(a){return parseInt(a.floor_number)+a.name};var t=function(a){var b="build/images/any-poi-icon-blue.png";return a.is_building_entrance?b="build/images/poi_icon_entrance-green.png":"Stair"==a.pois_type?b="build/images/poi_icon_stairs-orange.png":"Elevator"==a.pois_type&&(b="build/images/poi_icon_elevator-purple.png"),b},u=function(b){var c=t(b).replace(/\-[a-z]+\.png/gi,"-red.png"),d=h;return a.isFirefox&&(d=f),{url:c,size:d,scaledSize:h}},v=function(b){var c=g;return a.isFirefox&&(c=f),{url:t(b),size:c,scaledSize:g}},w=function(){for(var a in k)k.hasOwnProperty(a)&&k[a].polyline&&k[a].polyline.setMap(null);k={}},x=function(b,c){if(k){if(b&&b.floor_number){var d=b.floor_number;k[d]&&k[d].polyline&&k[d].polyline.setMap(a.gmapService.gmap)}if(c&&c.floor_number){var e=c.floor_number;

k[e]&&k[e].polyline&&k[e].polyline.setMap(null)}}};a.unselectBuilding=function(){a.anyService.selectedBuilding=void 0;try{"undefined"!=typeof Storage&&localStorage&&localStorage.removeItem("lastBuilding"),localStorage.removeItem("lastFloor"),localStorage.removeItem("lastPoi")}catch(b){}},a.clearNavPolylines=function(){w(),l&&l.setMap(null),c.isRouteShown()&&c.clearRoute(),m&&m.setMap(null),a.getIsUserLocVisible()||a.hideUserLocation()},a.navRoutesShown=function(){for(var a in k)if(k.hasOwnProperty(a)&&k[a].polyline&&k[a].polyline.getMap())return!0;return l&&l.getMap()?!0:c.isRouteShown()?!0:!1},a.zoomInPoi=function(){a.gmapService.gmap.panTo(s(a.anyService.selectedPoi)),a.gmapService.gmap.setZoom(20)},a.fetchAllPoisForBuilding=function(b){var c=d.jsonReq;c.buid=b.buid;var f=e.retrievePoisByBuilding(c);f.then(function(b){var c=b.data;a.myPois=c.pois;for(var d=a.myPois.length,e=d-1;e>=0;e--){var f=a.myPois[e].puid;"true"==a.myPois[e].is_building_entrance?(a.myPois[e].is_building_entrance=!0,a.myEntrances.push(a.myPois[e])):a.myPois[e].is_building_entrance=!1,a.myPoisHashT[f]={},a.myPoisHashT[f].model=a.myPois[e]}n=!0,a.drawPoisOnMapForBuilding(),a.showPoisOnlyForFloor(a.anyService.getFloorNumber())},function(a){a.data;q("Something went wrong while fetching POIs")})},a.retrieveRouteFromPoiToPoi=function(b,c){if(!b||!b.puid)return void q("Source POI is corrupted.");if(!c||!c.puid)return void q("Source POI is corrupted.");var d=a.creds;d.pois_from=b.puid,d.pois_to=c.puid;var f=e.retrieveRouteFromPoiToPoi(d);f.then(function(c){var d=c.data,e=d.pois;w();for(var f=0;f<e.length;f++)if(e[f].lat&&e[f].lon&&e[f].floor_number){var g=e[f].floor_number;k.hasOwnProperty(g)||(k[g]={flightPlanCoordinates:[]}),k[g].flightPlanCoordinates.push(new google.maps.LatLng(parseFloat(e[f].lat),parseFloat(e[f].lon)))}for(var h in k)k.hasOwnProperty(h)&&(k[h].polyline=new google.maps.Polyline({path:k[h].flightPlanCoordinates,geodesic:!0,strokeColor:"#FF0000",strokeOpacity:.75,strokeWeight:6}),a.anyService.selectedFloor.floor_number==h&&k[h].polyline.setMap(a.gmapService.gmap));if(j){var i={path:"M 0,-1 0,1",strokeOpacity:.75,scale:4};m=new google.maps.Polyline({path:[new google.maps.LatLng(parseFloat(b.coordinates_lat),parseFloat(b.coordinates_lon)),new google.maps.LatLng(a.userPosition.lat,a.userPosition.lng)],geodesic:!0,strokeColor:"#FF0000",strokeOpacity:0,strokeWeight:6,icons:[{icon:i,offset:"0",repeat:"20px"}]}),m.setMap(a.gmapService.gmap),j=void 0}},function(a){a.data;q("Something went wrong while fetching route.")})};var y=function(a,b,c,d){return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))},z=function(b){var c=parseFloat(b.coordinates_lat),d=parseFloat(b.coordinates_lon),e=a.myEntrances;e&&e.length||(e=a.myPois);for(var f=Number.MAX_VALUE,g=void 0,h=0;h<e.length;h++){if(e[h].puid==b.puid)return b;var i,j=parseFloat(e[h].coordinates_lat),k=parseFloat(e[h].coordinates_lon);e&&e.length>0&&(i=y(c,d,j,k)),f>i&&(f=i,g=e[h])}return g};a.getPoiShareUrl=function(b){if(b===a.poiShareUrl.puid)return void(a.poiShareUrl.puid=void 0);a.poiShareUrl.puid=b,a.anyService.selectedPoi&&a.anyService.selectedPoi.puid==b||(a.anyService.selectedPoi=a.myPoisHashT[b].model);var c=a.anyService.getViewerUrl();a.poiShareUrl.embed='<iframe width="100%" height="500" frameborder="0" scrolling="yes" marginheight="0" marginwidth="0" src="'+c+'"></iframe>';var d={longUrl:c},e=a.anyAPI.googleUrlShortener(d);e.then(function(b){a.poiShareUrl.url=b.data.id},function(b){a.poiShareUrl.url=c})},a.startNavFromPoi=function(){a.poiRouteState.from=a.anyService.selectedPoi,r("Now you can click on another POI to draw the indoor path between the 2 points.")},a.getHtml5GeoLocation=function(a,b){navigator.geolocation?navigator.geolocation.getCurrentPosition(a,b):q("The Geolocation feature is not supported by this browser.")},a.navigateFromUserToPoiAux=function(b){if(!b)return void q("Invalid position detected by HTML5.");var c=b.lat,d=b.lng;a.userPosition||(a.userPosition={lat:c,lng:d});var e=new google.maps.LatLng(c,d),f=a.anyService.selectedPoi;if(!f)return void q("No target poi found.");if(C(c,d)){var g,h=Number.MAX_VALUE,i=void 0,k=a.myPoisHashT;for(var m in k)if(k.hasOwnProperty(m)){var n=k[m].model;if(!n||n.floor_number!=f.floor_number)continue;(g=y(parseFloat(n.coordinates_lat),parseFloat(n.coordinates_lon),c,d))<=h&&(h=g,i=n)}return j=i,a.retrieveRouteFromPoiToPoi(i,f),void(a.getIsUserLocVisible()||a.displayMyLocMarker({lat:c,lng:d}))}j=void 0;var o=new google.maps.LatLng(parseFloat(f.coordinates_lat),parseFloat(f.coordinates_lon)),p=z(f);p&&(o=new google.maps.LatLng(parseFloat(p.coordinates_lat),parseFloat(p.coordinates_lon))),a.gmapService.calcRoute(e,o,function(b){if(b){var c=a.anyService.selectedPoi;if(p){var d=p,e=[b,new google.maps.LatLng(parseFloat(d.coordinates_lat),parseFloat(d.coordinates_lon))];l&&l.setMap(null);var f={path:"M 0,-1 0,1",strokeOpacity:.75,scale:4};l=new google.maps.Polyline({path:e,geodesic:!0,strokeColor:"#73B9FF",strokeOpacity:0,strokeWeight:6,icons:[{icon:f,offset:"0",repeat:"20px"}]}),l.setMap(a.gmapService.gmap),d.puid!=c.puid&&a.retrieveRouteFromPoiToPoi(d,c)}}})},a.navigateFromUserToPoi=function(b){a.anyService.selectedPoi&&a.anyService.selectedPoi.puid==b||(a.anyService.selectedPoi=a.myPoisHashT[b].model),a.getIsUserLocVisible()&&a.userPosition?a.navigateFromUserToPoiAux(a.userPosition):a.getHtml5GeoLocation(function(b){var c=b.coords.latitude,d=b.coords.longitude;a.navigateFromUserToPoiAux({lat:c,lng:d})},function(b){a.$apply(function(){q(1==b.code?"Permission denied. Anyplace was not able to retrieve your Geolocation.":2==b.code?"Position unavailable. The network is down or the positioning satellites couldn't be contacted.":3==b.code?"Timeout. The request for retrieving your Geolocation was timed out.":"There was an error while retrieving your Geolocation. Please try again.")})})},a.drawPoisOnMapForBuilding=function(){var d=new google.maps.InfoWindow({content:"-",maxWidth:500}),e=void 0,f=-1;try{"undefined"==typeof Storage||!localStorage||LPUtils.isNullOrUndefined(localStorage.getItem("lastBuilding"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastFloor"))||LPUtils.isNullOrUndefined(localStorage.getItem("lastPoi"))||(e=localStorage.getItem("lastPoi"))}catch(h){}for(var i=!1,j=void 0,k=-1,l=0;l<a.myPois.length;l++){var m=a.myPois[l];e&&m.puid===e&&(f=l),a.urlPuid&&a.urlPuid==m.puid&&(k=l);var n,o="-";if("None"!=m.pois_type){var p=t(m),q=g;a.isFirefox&&(q=new google.maps.Size(62,93));var r=g;n=new google.maps.Marker({position:s(m),map:c.gmap,draggable:!1,icon:{url:p,size:q,scaledSize:r},visible:!1}),o='<div class="iw infowindow-scroll-fix"><div class="wordwrap" style="text-align: center"><span ng-show="navRoutesShown()" id="info-window-zoomin" ng-click="zoomInPoi()"><img src="build/images/html5_location_icon.png"></span><span class="iw-poi-name">'+m.name+'</span></div><div class="wordwrap iw-poi-description" ng-show="showPoiDescription">'+m.description+'</div><div style="text-align: center"><div class="poi-action-btn"><button class="btn btn-info" ng-click="togglePoiDescription()"><i class="fa fa-info-circle"></i></i></button></div><div class="poi-action-btn"><button class="btn btn-primary" ng-click="startNavFromPoi()"><i style="font-size: 12px;" class="fa fa-flag"></i></button></div><div class="poi-action-btn"><button class="btn btn-success" ng-click="navigateFromUserToPoi(\''+m.puid+'\')"><i class="fa fa-location-arrow"></i></button></div><div class="poi-action-btn"><button class="btn btn-warning" ng-click="getPoiShareUrl(\''+m.puid+'\')"><i class="fa fa-share-alt"></i></button></div></div><div ng-show="poiShareUrl.puid" style="margin-top: 2px"><div>Share URL:</div><input class="form-control" value="{{poiShareUrl.url}}"/><div>Embed:</div><input class="form-control" value="{{poiShareUrl.embed}}"/></div></div>';var u=b(o)(a);n.tpl2=u[0],n.model=m,n.infowindow=d,a.myPoisHashT[m.puid].marker=n,google.maps.event.addListener(n,"click",function(){var b=this;a.$apply(function(){if(b.model&&b.model.puid){if(a.poiRouteState.from){var d=a.poiRouteState.from;return a.retrieveRouteFromPoiToPoi(d,b.model),d&&d.puid&&a.myPoisHashT[d.puid]&&a.myPoisHashT[d.puid].marker&&(b.infowindow.setContent(a.myPoisHashT[d.puid].marker.tpl2),b.infowindow.open(c.gmap,a.myPoisHashT[d.puid].marker)),void(a.poiRouteState.from=void 0)}a.poiRouteState.from=void 0,a.anyService.selectedPoi&&a.anyService.selectedPoi.puid!=b.model.puid&&a.navRoutesShown()&&a.clearNavPolylines(),a.anyService.selectedPoi&&a.anyService.selectedPoi.puid==b.model.puid&&(b.infowindow.setContent(b.tpl2),b.infowindow.open(c.gmap,b)),a.anyService.selectedPoi=b.model}})}),i&&m.is_building_entrance&&(j=m,i=!0)}}k>=0?a.anyService.selectedPoi=a.myPois[k]:f>=0?a.anyService.selectedPoi=a.myPois[f]:i&&j&&(a.anyService.selectedPoi=j)},a.showPoisOnlyForFloor=function(b){for(var c=0;c<a.myPois.length;c++){var d=a.myPois[c];if(d&&a.myPoisHashT[d.puid]&&a.myPoisHashT[d.puid].marker){var e=a.myPoisHashT[d.puid].marker;d.floor_number!=b?(e.setVisible(!1),e.infowindow&&e.infowindow.getMap()&&e.infowindow.setMap(null)):e.setVisible(!0)}}},a.removePoisOnMap=function(){for(var b=0;b<a.myPois.length;b++){var c=a.myPois[b];c&&a.myPoisHashT[c.puid]&&a.myPoisHashT[c.puid].marker&&(a.myPoisHashT[c.puid].marker.setMap(null),delete a.myPoisHashT[c.puid])}};var A=function(){for(var b=0;b<a.myPois.length;b++){var c=a.myPois[b];if((!a.anyService.selectedPoi||c.puid!=a.anyService.selectedPoi.puid)&&c&&a.myPoisHashT[c.puid]&&a.myPoisHashT[c.puid].marker){var d=a.myPoisHashT[c.puid].marker;d.setVisible(!1)}}},B=function(){for(var b=0;b<a.myPois.length;b++){var c=a.myPois[b];if(c.floor_number==a.anyService.getFloorNumber()&&c&&a.myPoisHashT[c.puid]&&a.myPoisHashT[c.puid].marker){var d=a.myPoisHashT[c.puid].marker;d.setVisible(!0)}}},C=function(b,c){var d=a.anyService.selectedFloor;if(!d)return!1;var e=parseFloat(d.bottom_left_lat),f=parseFloat(d.bottom_left_lng),g=parseFloat(d.top_right_lat),h=parseFloat(d.top_right_lng),i=y(e,f,g,h)/2,j=(e+g)/2,k=(f+h)/2,l=y(j,k,b,c);return i>=l}}]);